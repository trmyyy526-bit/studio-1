<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BM AI STUDIO - Trình Tạo Ảnh Đa Năng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Thay đổi script src để dùng bản UMD ổn định hơn -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #111827;
            color: #f3f4f6;
        }
        .tool-card, .option-card {
            border: 2px solid #4b5563;
            border-radius: 1rem;
            padding: 1.5rem 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-align: center;
            background-color: #1f2937;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }
        .tool-card:hover, .option-card:hover, .option-card.selected {
            border-color: #6366f1;
            background-color: #374151;
            transform: translateY(-4px);
        }
        .step-card {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 1.5rem;
            display: none;
        }
        .step-card.active {
            display: block;
        }
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: block;
            cursor: pointer;
            border: 2px dashed #4b5563;
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            width: 100%;
            transition: border-color 0.2s;
            background-color: #111827;
        }
        .file-input-wrapper:hover {
            border-color: #6366f1;
        }
        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        .preview-img {
            max-width: 120px;
            max-height: 120px;
            object-fit: cover;
            border-radius: 0.5rem;
            margin: 0.5rem auto;
        }
        .loader {
            border: 4px solid #374151;
            border-radius: 50%;
            border-top: 4px solid #6366f1;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: #6366f1; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #4f46e5; }
        .btn-secondary { background-color: #374151; color: #f3f4f6; }
        .btn-secondary:hover:not(:disabled) { background-color: #4b5563; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.7); display: flex;
            align-items: center; justify-content: center; z-index: 50;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content {
            background-color: #1f2937; padding: 2rem; border-radius: 1rem;
            border: 1px solid #374151; text-align: center;
            transform: scale(0.95); transition: transform 0.3s ease;
            max-width: 90vw; width: 500px;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .result-image-wrapper {
            position: relative; background-color: #374151;
            border-radius: 0.5rem; overflow: hidden;
        }
        .remove-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            background-color: rgba(75, 85, 99, 0.7);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            line-height: 1;
            transition: all 0.2s;
            font-weight: bold;
        }
        .remove-btn:hover {
            background-color: #ef4444;
            transform: scale(1.1);
        }
        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
        }
        .upload-box {
            border: 2px dashed #4b5563;
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 1.5rem;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            position: relative;
            overflow: hidden;
            background-color: #1f2937;
        }
        .upload-box-main {
            height: 250px;
        }
        .upload-box-style {
            height: 180px;
        }
        .upload-box:hover {
            background-color: #374151;
            border-color: #6366f1;
        }
        .upload-box img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 10;
        }
        .upload-box .placeholder {
            z-index: 5;
        }
        /* Styles for new tool */
        .image-preview {
            width: 100%;
            height: 200px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            border: 2px dashed #4b5563;
            text-align: center;
            padding: 10px;
        }
        .vn-tool-loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .vn-modal-content {
            background-color: #1f2937;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 90%;
            width: 500px;
            text-align: center;
            color: white;
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #9ca3af;
            cursor: pointer;
        }
        .suggestions-list {
            position: absolute;
            background-color: #374151;
            border: 1px solid #4b5563;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            width: 100%;
            left: 0;
        }
        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            text-align: left;
        }
        .suggestion-item:hover {
            background-color: #4b5563;
        }
        .aspect-ratio-container {
            position: relative;
            width: 100%;
            max-width: 360px;
            margin: auto;
            aspect-ratio: 9 / 16;
            overflow: hidden;
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            cursor: zoom-in;
        }
        .aspect-ratio-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .gallery-item {
            cursor: zoom-in;
            border: 2px solid transparent;
            aspect-ratio: 9 / 16;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .gallery-item.selected {
            border-color: #3b82f6;
        }
        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <button id="back-to-selection-btn" class="hidden btn btn-secondary absolute top-4 left-4" onclick="showToolSelection()">
                <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Quay lại
            </button>
            <h1 class="text-4xl md:text-5xl font-bold tracking-tight text-white">STUDIO</h1>
            <p id="header-subtitle" class="text-lg text-gray-400 mt-2">Người tạo: TRAN MY</p>
        </header>

        <main id="app-container">
            <!-- Tool Selection -->
            <div id="tool-selection" class="animate-fade-in">
                <h2 class="text-3xl font-bold mb-8 text-center">Bạn muốn tạo gì hôm nay?</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-5xl mx-auto">
                    <div class="tool-card" onclick="selectTool('model')">
                        <i data-lucide="user-round" class="h-16 w-16 mx-auto mb-4 text-indigo-400"></i>
                        <h3 class="text-xl font-bold">Ảnh với Người Mẫu</h3>
                        <p class="text-gray-400 mt-2">Ghép trang phục vào người mẫu trong nhiều bối cảnh khác nhau.</p>
                    </div>
                    <div class="tool-card" onclick="selectTool('product')">
                        <i data-lucide="package" class="h-16 w-16 mx-auto mb-4 text-indigo-400"></i>
                        <h3 class="text-xl font-bold">Ảnh Sản Phẩm</h3>
                        <p class="text-gray-400 mt-2">Tạo ảnh quảng cáo cho sản phẩm mà không cần người mẫu.</p>
                    </div>
                    <div class="tool-card" onclick="selectTool('accessory')">
                        <i data-lucide="scissors" class="h-16 w-16 mx-auto mb-4 text-indigo-400"></i>
                        <h3 class="text-xl font-bold">Tách Nền & Sáng tạo Phụ kiện</h3>
                        <p class="text-gray-400 mt-2">Tách nền sản phẩm (kể cả khi có người mẫu) và để AI sáng tạo phụ kiện.</p>
                    </div>
                    <div class="tool-card" onclick="selectTool('design')">
                        <i data-lucide="palette" class="h-16 w-16 mx-auto mb-4 text-indigo-400"></i>
                        <h3 class="text-xl font-bold">Tùy biến Thiết kế</h3>
                        <p class="text-gray-400 mt-2">Thay đổi màu sắc hoặc phối chất liệu vải mới cho trang phục.</p>
                    </div>
                    <div class="tool-card" onclick="selectTool('creative-design')">
                        <i data-lucide="lightbulb" class="h-16 w-16 mx-auto mb-4 text-indigo-400"></i>
                        <h3 class="text-xl font-bold">Sáng tạo Bộ Sưu Tập</h3>
                        <p class="text-gray-400 mt-2">Phát triển bộ sưu tập thời trang mới từ hình ảnh ý tưởng.</p>
                    </div>
                    <div class="tool-card" onclick="selectTool('aspect-ratio')">
                        <i data-lucide="ratio" class="h-16 w-16 mx-auto mb-4 text-indigo-400"></i>
                        <h3 class="text-xl font-bold">Thay Đổi Tỷ Lệ Hàng Loạt</h3>
                        <p class="text-gray-400 mt-2">Cắt nhiều ảnh theo tỷ lệ bạn chọn và tải xuống từng ảnh.</p>
                    </div>
                     <div class="tool-card" onclick="selectTool('video-script')">
                        <i data-lucide="film" class="h-16 w-16 mx-auto mb-4 text-indigo-400"></i>
                        <h3 class="text-xl font-bold">Tạo Kịch Bản Video</h3>
                        <p class="text-gray-400 mt-2">Biến hình ảnh tĩnh thành kịch bản video quảng cáo chi tiết.</p>
                    </div>
                    <div class="tool-card" onclick="selectTool('face-swap')">
                        <i data-lucide="user-cog" class="h-16 w-16 mx-auto mb-4 text-indigo-400"></i>
                        <h3 class="text-xl font-bold">Tạo ảnh với hình ảnh có sẵn</h3>
                        <p class="text-gray-400 mt-2">Kết hợp gương mặt, trang phục và phong cách để tạo người mẫu ảnh độc đáo.</p>
                    </div>
                    <div class="tool-card" onclick="selectTool('vietnam-photoshoot')">
                        <i data-lucide="camera" class="h-16 w-16 mx-auto mb-4 text-indigo-400"></i>
                        <h3 class="text-xl font-bold">Ảnh tại Danh lam Thắng cảnh</h3>
                        <p class="text-gray-400 mt-2">Tạo ảnh người mẫu tại các địa danh nổi tiếng của Việt Nam.</p>
                    </div>
                </div>
            </div>

            <!-- Tool 1: Model Photoshoot -->
            <div id="model-tool-container" class="hidden">
                <!-- Step Progress Bar -->
                <div id="progress-container" class="w-full bg-gray-700 rounded-full h-2.5 mb-8">
                    <div id="progress-bar" class="bg-indigo-500 h-2.5 rounded-full transition-all duration-500" style="width: 10%"></div>
                </div>
                <div id="step-1" class="step-card active">
                    <h2 class="text-2xl font-bold mb-1 text-indigo-400">Bước 1: Tải lên Dữ liệu</h2>
                    <p class="text-gray-400 mb-6">Chọn ảnh người mẫu, trang phục và phụ kiện (tùy chọn).</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="file-input-wrapper" id="model-uploader"><i data-lucide="user-square-2" class="mx-auto h-12 w-12 text-gray-500"></i><span class="mt-2 block text-sm font-medium text-gray-300">Ảnh Người Mẫu</span><input type="file" accept="image/*" onchange="previewImage(event, 'model-preview')"><img id="model-preview" class="hidden preview-img" alt="Xem trước người mẫu"></div>
                        <div class="file-input-wrapper" id="outfit-uploader"><i data-lucide="shirt" class="mx-auto h-12 w-12 text-gray-500"></i><span class="mt-2 block text-sm font-medium text-gray-300">Ảnh Trang Phục</span><input type="file" accept="image/*" onchange="previewImage(event, 'outfit-preview')"><img id="outfit-preview" class="hidden preview-img" alt="Xem trước trang phục"></div>
                        <div class="file-input-wrapper" id="accessory-uploader"><i data-lucide="gem" class="mx-auto h-12 w-12 text-gray-500"></i><span class="mt-2 block text-sm font-medium text-gray-300">Phụ Kiện (Tùy chọn)</span><input type="file" accept="image/*" onchange="previewImage(event, 'accessory-preview')"><img id="accessory-preview" class="hidden preview-img" alt="Xem trước phụ kiện"></div>
                    </div>
                    <div class="flex items-center justify-center space-x-8"><label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="gender" value="male" class="form-radio h-5 w-5 text-indigo-500 bg-gray-700 border-gray-600 focus:ring-indigo-500"><span class="text-lg">Nam</span></label><label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="gender" value="female" class="form-radio h-5 w-5 text-indigo-500 bg-gray-700 border-gray-600 focus:ring-indigo-500" checked><span class="text-lg">Nữ</span></label></div>
                </div>
                <div id="step-2" class="step-card">
                    <h2 class="text-2xl font-bold mb-1 text-indigo-400">Bước 2: Thêm Thành Viên (Tùy chọn)</h2>
                    <p class="text-gray-400 mb-6">Thêm người, thú cưng hoặc sinh vật khác vào ảnh. Các tùy chọn bạn điền sẽ được AI diễn giải để tạo ra kết quả phù hợp nhất.</p>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Card Nam -->
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 space-y-3">
                            <h3 class="font-bold text-lg flex items-center"><i data-lucide="user" class="w-5 h-5 mr-2"></i>Nam</h3>
                            <div class="file-input-wrapper !p-2 !border-solid" id="companion-male-uploader">
                                 <span class="text-sm font-medium text-gray-300">Thêm ảnh tham chiếu (tùy chọn)</span>
                                 <input type="file" accept="image/*" onchange="previewImage(event, 'companion-male-preview')">
                                 <img id="companion-male-preview" class="hidden preview-img !m-0 !mt-2" alt="Xem trước">
                            </div>
                            <input type="text" id="companion-male-hair" class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-sm" placeholder="Kiểu tóc (ví dụ: tóc ngắn, tóc xoăn...)">
                            <input type="text" id="companion-male-age" class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-sm" placeholder="Độ tuổi (ví dụ: khoảng 25 tuổi)">
                            <p class="text-sm font-medium text-gray-300 pt-2">Trang phục:</p>
                            <div class="grid grid-cols-2 gap-2 text-sm" data-group="male-outfit">
                                <div class="option-card !p-2" onclick="selectOne(this, 'male-outfit')">Sơ mi & Quần tây</div>
                                <div class="option-card !p-2" onclick="selectOne(this, 'male-outfit')">Áo thun & Jeans</div>
                            </div>
                             <input type="text" id="companion-male-outfit-custom" class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-sm" placeholder="Hoặc nhập trang phục tùy chọn...">
                        </div>
                
                        <!-- Card Nữ -->
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 space-y-3">
                            <h3 class="font-bold text-lg flex items-center"><i data-lucide="user" class="w-5 h-5 mr-2"></i>Nữ</h3>
                            <div class="file-input-wrapper !p-2 !border-solid" id="companion-female-uploader">
                                 <span class="text-sm font-medium text-gray-300">Thêm ảnh tham chiếu (tùy chọn)</span>
                                 <input type="file" accept="image/*" onchange="previewImage(event, 'companion-female-preview')">
                                 <img id="companion-female-preview" class="hidden preview-img !m-0 !mt-2" alt="Xem trước">
                            </div>
                            <input type="text" id="companion-female-hair" class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-sm" placeholder="Kiểu tóc (ví dụ: tóc dài, tóc búi...)">
                            <input type="text" id="companion-female-age" class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-sm" placeholder="Độ tuổi (ví dụ: khoảng 22 tuổi)">
                            <p class="text-sm font-medium text-gray-300 pt-2">Trang phục:</p>
                             <div class="file-input-wrapper !p-2 !border-solid" id="companion-female-outfit-uploader">
                                 <span class="text-sm font-medium text-gray-300">Tải lên trang phục (tùy chọn)</span>
                                 <input type="file" accept="image/*" onchange="previewImage(event, 'companion-female-outfit-preview')">
                                 <img id="companion-female-outfit-preview" class="hidden preview-img !m-0 !mt-2" alt="Xem trước trang phục nữ">
                            </div>
                             <div class="text-sm text-gray-400 text-center mt-1">Nếu không tải ảnh, AI sẽ tạo trang phục giống người mẫu chính.</div>
                        </div>
                
                        <!-- Card Em bé -->
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 space-y-3">
                            <h3 class="font-bold text-lg flex items-center"><i data-lucide="baby" class="w-5 h-5 mr-2"></i>Em bé</h3>
                             <div class="file-input-wrapper !p-2 !border-solid" id="companion-baby-uploader">
                                 <span class="text-sm font-medium text-gray-300">Thêm ảnh tham chiếu (tùy chọn)</span>
                                 <input type="file" accept="image/*" onchange="previewImage(event, 'companion-baby-preview')">
                                 <img id="companion-baby-preview" class="hidden preview-img !m-0 !mt-2" alt="Xem trước">
                            </div>
                            <input type="text" id="companion-baby-hair" class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-sm" placeholder="Kiểu tóc (ví dụ: tóc xoăn nhẹ...)">
                            <input type="text" id="companion-baby-age" class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-sm" placeholder="Độ tuổi (ví dụ: khoảng 2 tuổi)">
                            <input type="text" id="companion-baby-accessories" class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-sm" placeholder="Phụ kiện (ví dụ: nơ cài tóc, yếm...)">
                             <div class="bg-gray-900 p-3 rounded-md text-sm text-gray-300">
                                <i data-lucide="info" class="w-4 h-4 inline-block mr-1"></i> Trang phục sẽ được AI tạo cho giống với trang phục của người mẫu chính.
                            </div>
                        </div>
                
                        <!-- Card Thú cưng & Thần thú -->
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 space-y-4">
                             <div>
                                 <h3 class="font-bold text-lg flex items-center mb-2"><i data-lucide="cat" class="w-5 h-5 mr-2"></i>Thú cưng</h3>
                                 <input type="text" id="companion-pet" class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-sm" placeholder="Nhập loại thú cưng (ví dụ: chó Corgi, mèo Anh lông dài...)">
                             </div>
                             <div class="border-t border-gray-700 my-4"></div>
                             <div>
                                <h3 class="font-bold text-lg flex items-center mb-2"><i data-lucide="git-fork" class="w-5 h-5 mr-2"></i>Thần thú</h3>
                                <input type="text" id="companion-mythical" class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-sm" placeholder="Nhập tên thần thú (ví dụ: rồng, phượng hoàng...)">
                                 <label class="flex items-center space-x-2 mt-3 cursor-pointer text-gray-300">
                                    <input type="checkbox" id="companion-mythical-giant" class="form-checkbox h-4 w-4 text-indigo-500 bg-gray-700 border-gray-600 rounded">
                                    <span class="text-sm">Kích thước khổng lồ (lớn hơn người mẫu)</span>
                                </label>
                             </div>
                        </div>
                    </div>
                </div>
                <div id="step-3" class="step-card">
                    <h2 class="text-2xl font-bold mb-1 text-indigo-400">Bước 3: Trợ Lý AI (Tùy chọn)</h2>
                    <p class="text-gray-400 mb-6">Chọn một trong các chế độ bên dưới để AI hỗ trợ bạn. Chọn một tùy chọn sẽ bỏ qua các bước tùy chỉnh thủ công.</p>
                    <div class="space-y-4">
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <i data-lucide="sparkles" class="h-8 w-8 text-yellow-400"></i>
                                    <div>
                                        <h3 class="font-bold text-lg">AI Tự Động Sáng Tạo</h3>
                                        <p class="text-sm text-gray-400">Để AI toàn quyền quyết định phong cách.</p>
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="generateImages(true, '', true)">Bắt đầu</button>
                            </div>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h3 class="font-bold text-lg mb-2 flex items-center"><i data-lucide="lightbulb" class="h-6 w-6 mr-2 text-indigo-400"></i>Sáng Tạo Theo Ý Tưởng Của Bạn</h3>
                            <textarea id="ai-idea-prompt" rows="3" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Nhập ý tưởng chính của bạn ở đây... Ví dụ: chụp ảnh concept mùa thu với lá vàng rơi, tông màu ấm áp..."></textarea>
                            <button class="btn btn-primary mt-3 w-full" onclick="generateWithIdea()">Tạo Ảnh Từ Ý Tưởng</button>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h3 class="font-bold text-lg mb-2 flex items-center"><i data-lucide="bot" class="h-6 w-6 mr-2 text-green-400"></i>Để AI Gợi Ý Kịch Bản</h3>
                            <p class="text-sm text-gray-400 mb-4">AI sẽ phân tích ảnh và đưa ra 3 kịch bản chụp ảnh độc đáo để bạn lựa chọn.</p>
                            <button id="get-suggestions-btn" class="btn btn-secondary w-full" onclick="getAISuggestions()">Nhận 3 Gợi Ý Chụp Ảnh</button>
                            <div id="suggestions-container" class="mt-4 space-y-3 hidden">
                            </div>
                        </div>
                    </div>
                </div>
                <div id="manual-steps">
                    <div id="step-4" class="step-card">
                        <h2 class="text-2xl font-bold mb-4 text-indigo-400">Bước 4: Chọn Dáng</h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4" data-group="pose">
                            <div class="option-card" data-value="natural candid pose" onclick="selectOne(this, 'pose')">Tự nhiên<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                            <div class="option-card" data-value="professional fashion model pose" onclick="selectOne(this, 'pose')">Người mẫu<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                            <div class="option-card" data-value="tall and elegant pose" onclick="selectOne(this, 'pose')">Cao ráo<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                            <div class="option-card" data-value="petite and cute pose" onclick="selectOne(this, 'pose')">Nhỏ nhắn<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                            <div class="option-card" data-value="curvy and confident pose" onclick="selectOne(this, 'pose')">Đầy đặn<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                        </div>
                        <div class="mt-6 bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <label for="custom-pose-input" class="block text-sm font-medium text-gray-300 mb-2">Thêm tùy chọn mới</label>
                            <div class="flex gap-2">
                                <input type="text" id="custom-pose-input" class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Nhập tên phong cách...">
                                <button class="btn btn-secondary whitespace-nowrap" onclick="addCustomOption('pose')">Thêm</button>
                            </div>
                        </div>
                    </div>
                    <div id="step-5" class="step-card">
                        <h2 class="text-2xl font-bold mb-6 text-indigo-400">Bước 5: Tùy chỉnh chi tiết</h2>
                        <div class="space-y-8">
                            <div>
                                <label class="font-semibold mb-3 block">Kiểu Tóc</label>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4" data-group="hair-style">
                                    <div class="option-card" data-value="long wavy hair" onclick="selectOne(this, 'hair-style')">Tóc dài gợn sóng<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                    <div class="option-card" data-value="short bob hair" onclick="selectOne(this, 'hair-style')">Tóc ngắn Bob<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                    <div class="option-card" data-value="elegant updo" onclick="selectOne(this, 'hair-style')">Tóc búi cao<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                    <div class="option-card" data-value="playful ponytail" onclick="selectOne(this, 'hair-style')">Tóc đuôi ngựa<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                </div>
                                <div class="mt-4 bg-gray-800 p-4 rounded-lg border border-gray-700">
                                    <div class="flex gap-2">
                                        <input type="text" id="custom-hair-style-input" class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Thêm kiểu tóc...">
                                        <button class="btn btn-secondary whitespace-nowrap" onclick="addCustomOption('hair-style')">Thêm</button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="font-semibold mb-3 block">Độ dài váy</label>
                                <div class="grid grid-cols-3 gap-4" data-group="dress-length">
                                    <div class="option-card" data-value="short dress" onclick="selectOne(this, 'dress-length')">Ngắn<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                    <div class="option-card" data-value="knee-length dress" onclick="selectOne(this, 'dress-length')">Ngang gối<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                    <div class="option-card" data-value="long flowing dress" onclick="selectOne(this, 'dress-length')">Dài<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                </div>
                                 <div class="mt-4 bg-gray-800 p-4 rounded-lg border border-gray-700">
                                    <div class="flex gap-2">
                                        <input type="text" id="custom-dress-length-input" class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Thêm độ dài...">
                                        <button class="btn btn-secondary whitespace-nowrap" onclick="addCustomOption('dress-length')">Thêm</button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="font-semibold mb-3 block">Bối cảnh</label>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4" data-group="background">
                                    <div class="option-card" data-value="in a professional photo studio, minimalist background" onclick="selectOne(this, 'background')">Studio<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                    <div class="option-card" data-value="on a stylish city street in Paris" onclick="selectOne(this, 'background')">Đường phố<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                    <div class="option-card" data-value="in a beautiful natural landscape with mountains" onclick="selectOne(this, 'background')">Thiên nhiên<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                    <div class="option-card" data-value="with stunning modern architecture" onclick="selectOne(this, 'background')">Kiến trúc<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                    <div class="option-card" data-value="in a cozy, stylish coffee shop with soft lighting" onclick="selectOne(this, 'background')">Quán cafe<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                    <div class="option-card" data-value="on a tropical beach at sunset" onclick="selectOne(this, 'background')">Bãi biển<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                    <div class="option-card" data-value="in a grand, classic library with tall bookshelves" onclick="selectOne(this, 'background')">Thư viện<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                    <div class="option-card" data-value="on a rooftop overlooking the city skyline at dusk" onclick="selectOne(this, 'background')">Sân thượng<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                </div>
                                 <div class="mt-4 bg-gray-800 p-4 rounded-lg border border-gray-700">
                                    <div class="flex gap-2">
                                        <input type="text" id="custom-background-input" class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Thêm bối cảnh...">
                                        <button class="btn btn-secondary whitespace-nowrap" onclick="addCustomOption('background')">Thêm</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="step-6" class="step-card">
                        <h2 class="text-2xl font-bold mb-6 text-indigo-400">Bước 6: Hoàn Thiện</h2>
                        <div class="space-y-8">
                            <div>
                                <label class="font-semibold mb-3 block">Tone màu</label>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4" data-group="color-tone">
                                    <div class="option-card" data-value="dreamy, bright and airy color grading" onclick="selectOne(this, 'color-tone')">Nàng thơ<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                    <div class="option-card" data-value="warm, nostalgic vintage film look" onclick="selectOne(this, 'color-tone')">Vintage<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                    <div class="option-card" data-value="dramatic, high-contrast cinematic style" onclick="selectOne(this, 'color-tone')">Điện ảnh<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                    <div class="option-card" data-value="classic black and white" onclick="selectOne(this, 'color-tone')">Đen trắng<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                </div>
                                <div class="mt-4 bg-gray-800 p-4 rounded-lg border border-gray-700">
                                    <div class="flex gap-2">
                                        <input type="text" id="custom-color-tone-input" class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Thêm tone màu...">
                                        <button class="btn btn-secondary whitespace-nowrap" onclick="addCustomOption('color-tone')">Thêm</button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="font-semibold mb-3 block">Chất lượng hình ảnh</label>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4" data-group="quality">
                                    <div class="option-card" data-value="8K, ultra-detailed, photorealistic" onclick="selectOne(this, 'quality')">8K<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                    <div class="option-card" data-value="hyperrealistic, sharp focus" onclick="selectOne(this, 'quality')">Realistic<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                    <div class="option-card" data-value="cinematic lighting, film grain" onclick="selectOne(this, 'quality')">Điện ảnh<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                    <div class="option-card" data-value="4K, high quality" onclick="selectOne(this, 'quality')">4K<button class="remove-btn" onclick="event.stopPropagation(); removeOption(this.parentElement)">&times;</button></div>
                                </div>
                                <div class="mt-4 bg-gray-800 p-4 rounded-lg border border-gray-700">
                                    <div class="flex gap-2">
                                        <input type="text" id="custom-quality-input" class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Thêm chất lượng...">
                                        <button class="btn btn-secondary whitespace-nowrap" onclick="addCustomOption('quality')">Thêm</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="step-7" class="step-card">
                        <h2 class="text-2xl font-bold mb-4 text-indigo-400">Bước 7: Chọn Tỉ lệ Khung hình</h2>
                        <p class="text-gray-400 mb-6">Chọn tỉ lệ khung hình cuối cùng cho các bức ảnh của bạn.</p>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4" data-group="final-aspect-ratio">
                            <div class="option-card selected" data-value="default (3:4 portrait)" onclick="selectOne(this, 'final-aspect-ratio')">
                                <i data-lucide="image" class="mx-auto h-8 w-8 mb-2"></i><span>Mặc định (3:4)</span>
                            </div>
                            <div class="option-card" data-value="1:1 (Square)" onclick="selectOne(this, 'final-aspect-ratio')">
                                <i data-lucide="square" class="mx-auto h-8 w-8 mb-2"></i><span>Vuông (1:1)</span>
                            </div>
                            <div class="option-card" data-value="4:3 (Landscape)" onclick="selectOne(this, 'final-aspect-ratio')">
                                <i data-lucide="rectangle-horizontal" class="mx-auto h-8 w-8 mb-2"></i><span>Ngang (4:3)</span>
                            </div>
                            <div class="option-card" data-value="16:9 (Widescreen)" onclick="selectOne(this, 'final-aspect-ratio')">
                                <i data-lucide="monitor" class="mx-auto h-8 w-8 mb-2"></i><span>Rộng (16:9)</span>
                            </div>
                            <div class="option-card" data-value="9:16 (Story/Reels)" onclick="selectOne(this, 'final-aspect-ratio')">
                                <i data-lucide="smartphone" class="mx-auto h-8 w-8 mb-2"></i><span>Story (9:16)</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="nav-buttons" class="flex justify-between mt-8"><button id="prev-btn" class="btn btn-secondary" onclick="changeStep(-1)" disabled>Quay lại</button><button id="next-btn" class="btn btn-primary" onclick="changeStep(1)">Tiếp theo</button><button id="generate-btn" class="hidden btn btn-primary" onclick="generateImages(false, '', true)"><span class="mr-2">Tạo Ảnh</span><i data-lucide="wand-2" class="w-5 h-5"></i></button></div>
            </div>
            
            <!-- Tool 2: Product Photoshoot -->
            <div id="product-tool-container" class="hidden">
                 <h2 class="text-3xl font-bold mb-6 text-center text-indigo-400">Tạo Ảnh Sản Phẩm</h2>
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div><h3 class="font-semibold mb-3 text-white">1. Tải lên Ảnh Sản Phẩm</h3><div class="file-input-wrapper" id="product-uploader"><i data-lucide="package-check" class="mx-auto h-12 w-12 text-gray-500"></i><span class="mt-2 block text-sm font-medium text-gray-300">Chọn ảnh sản phẩm</span><input type="file" accept="image/*" onchange="previewImage(event, 'product-preview')"><img id="product-preview" class="hidden preview-img" alt="Xem trước sản phẩm"></div></div>
                        <div><h3 class="font-semibold mb-3 text-white">2. Cung cấp Bối cảnh</h3><div class="flex border-b border-gray-700"><button id="tab-text" onclick="switchProductInput('text')" class="flex-1 p-3 font-semibold border-b-2 border-indigo-500 text-white">Dùng Mô tả</button><button id="tab-ref" onclick="switchProductInput('ref')" class="flex-1 p-3 font-semibold border-b-2 border-transparent text-gray-400">Dùng Ảnh tham chiếu</button></div><div id="product-text-input" class="mt-4"><textarea id="product-prompt" rows="5" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ví dụ: một chiếc túi xách da trên bàn đá cẩm thạch, bên cạnh một chậu cây nhỏ và một tách cà phê, ánh sáng buổi sáng dịu nhẹ..."></textarea></div><div id="product-ref-input" class="hidden mt-4"><div class="file-input-wrapper" id="ref-uploader"><i data-lucide="image-plus" class="mx-auto h-12 w-12 text-gray-500"></i><span class="mt-2 block text-sm font-medium text-gray-300">Tải lên Ảnh Tham chiếu</span><input type="file" accept="image/*" onchange="previewImage(event, 'ref-preview')"><img id="ref-preview" class="hidden preview-img" alt="Xem trước tham chiếu"></div></div></div>
                        <div><h3 class="font-semibold mb-3 text-white">3. Chọn Tỉ lệ Ảnh</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-4" data-group="product-aspect-ratio"><div class="option-card selected" data-value="1:1 (Square)" data-class="aspect-square" onclick="selectOne(this, 'product-aspect-ratio')"><i data-lucide="square" class="mx-auto h-8 w-8 mb-2"></i><span>Vuông (1:1)</span></div><div class="option-card" data-value="3:4 (Portrait)" data-class="aspect-[3/4]" onclick="selectOne(this, 'product-aspect-ratio')"><i data-lucide="rectangle-vertical" class="mx-auto h-8 w-8 mb-2"></i><span>Dọc (3:4)</span></div><div class="option-card" data-value="4:3 (Landscape)" data-class="aspect-[4/3]" onclick="selectOne(this, 'product-aspect-ratio')"><i data-lucide="rectangle-horizontal" class="mx-auto h-8 w-8 mb-2"></i><span>Ngang (4:3)</span></div><div class="option-card" data-value="16:9 (Widescreen)" data-class="aspect-video" onclick="selectOne(this, 'product-aspect-ratio')"><i data-lucide="monitor" class="mx-auto h-8 w-8 mb-2"></i><span>Rộng (16:9)</span></div></div></div>
                    </div>
                    <div class="flex flex-col"><div class="bg-gray-800 p-6 rounded-lg flex-grow flex flex-col justify-center text-center"><div><i data-lucide="wand-2" class="h-16 w-16 mx-auto mb-4 text-indigo-400"></i><h3 class="text-xl font-bold mb-4">Sẵn sàng Tạo ảnh?</h3><p class="text-gray-400 mb-6">Sau khi hoàn tất các bước, hãy nhấn nút bên dưới để bắt đầu quá trình sáng tạo của AI.</p></div><button class="btn btn-primary w-full mt-auto" onclick="generateProductImages()"><i data-lucide="image" class="w-5 h-5 mr-2"></i>Tạo ảnh sản phẩm ngay</button></div></div>
                </div>
            </div>

            <!-- Tool 3: Accessory Tool -->
            <div id="accessory-tool-container" class="hidden">
                <h2 class="text-3xl font-bold mb-6 text-center text-indigo-400">Tách Nền & Sáng tạo Phụ kiện</h2>
                <div class="grid md:grid-cols-2 gap-8 items-start">
                    <!-- Left Column: Upload and Product Display -->
                    <div class="space-y-6">
                        <div>
                            <h3 class="font-semibold mb-3 text-white">1. Tải lên Ảnh Trang phục</h3>
                            <div class="file-input-wrapper" id="accessory-product-uploader">
                                <i data-lucide="shirt" class="mx-auto h-12 w-12 text-gray-500"></i>
                                <span class="mt-2 block text-sm font-medium text-gray-300">Tải ảnh trang phục (có thể có người mẫu)</span>
                                <input type="file" accept="image/*" onchange="previewImage(event, 'accessory-product-preview')">
                                <img id="accessory-product-preview" class="hidden preview-img" alt="Xem trước sản phẩm">
                            </div>
                        </div>
                        <button id="process-product-btn" class="btn btn-primary w-full" onclick="processProductForAccessories()">
                            <i data-lucide="scissors" class="w-5 h-5 mr-2"></i>
                            Tách nền & Bắt đầu
                        </button>
                        <div id="product-display-wrapper" class="hidden">
                            <h3 class="font-semibold mb-3 text-white">Sản phẩm đã tách nền</h3>
                            <div id="product-display" class="result-image-wrapper flex items-center justify-center aspect-square bg-gray-800">
                                <!-- Background-removed image will go here -->
                            </div>
                        </div>
                    </div>
                    <!-- Right Column: Accessory Generation -->
                    <div id="accessory-generation-wrapper" class="space-y-6 hidden">
                        <div>
                             <h3 class="font-semibold mb-3 text-white">2. Phụ kiện do AI Sáng tạo</h3>
                             <div id="accessory-display" class="result-image-wrapper flex items-center justify-center aspect-square bg-gray-800">
                                 <div class="text-center text-gray-400 p-4">
                                    <i data-lucide="gem" class="w-12 h-12 mx-auto mb-4"></i>
                                    <p>Phụ kiện gợi ý sẽ xuất hiện ở đây.</p>
                                 </div>
                             </div>
                        </div>
                        <button id="generate-accessories-btn" class="btn btn-secondary w-full" onclick="generateAccessories()">
                            <i data-lucide="wand-2" class="w-5 h-5 mr-2"></i>
                            Sáng tạo Phụ kiện
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tool 4: Fashion Design -->
            <div id="design-tool-container" class="hidden">
                 <h2 class="text-3xl font-bold mb-6 text-center text-indigo-400">Công cụ Tùy biến Thiết kế</h2>
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Inputs -->
                    <div class="space-y-6">
                        <div>
                             <h3 class="font-semibold mb-3 text-white">1. Tải lên Ảnh Trang phục</h3>
                            <div class="file-input-wrapper" id="design-uploader">
                                <i data-lucide="shirt" class="mx-auto h-12 w-12 text-gray-500"></i>
                                <span class="mt-2 block text-sm font-medium text-gray-300">Chọn ảnh trang phục gốc</span>
                                <input type="file" accept="image/*" onchange="previewImage(event, 'design-preview')">
                                <img id="design-preview" class="hidden preview-img" alt="Xem trước trang phục">
                            </div>
                        </div>
                        
                        <div>
                             <h3 class="font-semibold mb-3 text-white">2. Chọn Chế độ Tùy biến</h3>
                            <div class="flex border-b border-gray-700">
                                <button id="tab-color" onclick="switchDesignInput('color')" class="flex-1 p-3 font-semibold border-b-2 border-indigo-500 text-white">Đổi Màu</button>
                                <button id="tab-fabric" onclick="switchDesignInput('fabric')" class="flex-1 p-3 font-semibold border-b-2 border-transparent text-gray-400">Phối Cận Vải</button>
                            </div>
                            <div id="design-color-input" class="mt-4">
                                <label for="design-color-prompt" class="block text-sm font-medium text-gray-300 mb-2">Mô tả màu sắc</label>
                                <div class="flex items-start gap-4">
                                    <div class="flex-grow">
                                        <textarea id="design-color-prompt" rows="3" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ví dụ: màu đỏ tươi, xanh navy, vàng pastel..."></textarea>
                                    </div>
                                    <div class="text-center">
                                        <label for="design-color-picker" class="block text-xs text-gray-400 mb-1">Hoặc chọn</label>
                                        <input type="color" id="design-color-picker" value="#6366f1" class="p-1 h-12 w-12 block bg-gray-800 border-none cursor-pointer rounded-lg">
                                    </div>
                                </div>
                            </div>
                            <div id="design-fabric-input" class="hidden mt-4">
                                <div class="file-input-wrapper" id="fabric-uploader">
                                    <i data-lucide="layers" class="mx-auto h-12 w-12 text-gray-500"></i>
                                    <span class="mt-2 block text-sm font-medium text-gray-300">1. Tải lên Ảnh Mẫu Vải</span>
                                    <input type="file" accept="image/*" onchange="previewImage(event, 'fabric-preview')">
                                    <img id="fabric-preview" class="hidden preview-img" alt="Xem trước mẫu vải">
                                </div>
                                <div class="mt-4">
                                    <label for="fabric-location-prompt" class="block text-sm font-medium text-gray-300 mb-2">2. Mô tả vị trí áp dụng vải</label>
                                    <textarea id="fabric-location-prompt" rows="2" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ví dụ: áp dụng cho toàn bộ chiếc váy, chỉ thay cho phần tay áo..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Actions -->
                    <div class="flex flex-col">
                        <div class="bg-gray-800 p-6 rounded-lg flex-grow flex flex-col justify-center text-center">
                             <div>
                                <i data-lucide="palette" class="h-16 w-16 mx-auto mb-4 text-indigo-400"></i>
                                <h3 class="text-xl font-bold mb-4">Sẵn sàng Tùy biến?</h3>
                                <p class="text-gray-400 mb-6">Sau khi tải ảnh và chọn chế độ, nhấn nút bên dưới để AI bắt đầu biến hóa trang phục của bạn.</p>
                            </div>
                            <button class="btn btn-primary w-full mt-auto" onclick="generateDesignImages()">
                                <i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>
                                Áp dụng Tùy biến
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tool 5: Creative Design -->
            <div id="creative-design-tool-container" class="hidden">
                 <h2 class="text-3xl font-bold mb-6 text-center text-indigo-400">Sáng tạo Bộ Sưu Tập</h2>
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div>
                             <h3 class="font-semibold mb-3 text-white">1. Tải lên Ảnh Ý tưởng</h3>
                            <div class="file-input-wrapper" id="creative-uploader">
                                <i data-lucide="image" class="mx-auto h-12 w-12 text-gray-500"></i>
                                <span class="mt-2 block text-sm font-medium text-gray-300">Chọn ảnh làm nguồn cảm hứng</span>
                                <input type="file" accept="image/*" onchange="previewImage(event, 'creative-preview')">
                                <img id="creative-preview" class="hidden preview-img" alt="Xem trước ảnh ý tưởng">
                            </div>
                        </div>
                        <div>
                             <h3 class="font-semibold mb-3 text-white">2. Chọn Chế độ Sáng tạo</h3>
                            <div class="flex border-b border-gray-700">
                                <button id="tab-auto" onclick="switchCreativeInput('auto')" class="flex-1 p-3 font-semibold border-b-2 border-indigo-500 text-white">AI Tự Sáng tạo</button>
                                <button id="tab-manual" onclick="switchCreativeInput('manual')" class="flex-1 p-3 font-semibold border-b-2 border-transparent text-gray-400">Mô tả Ý tưởng</button>
                            </div>
                            <div id="creative-auto-input" class="mt-4">
                                <p class="text-gray-400 text-center bg-gray-800 p-4 rounded-lg">AI sẽ tự động tạo ra một bộ sưu tập 12 thiết kế đa dạng (Đầm, Áo, Set bộ, Quần & Chân váy) dựa trên phong cách từ ảnh bạn tải lên.</p>
                            </div>
                            <div id="creative-manual-input" class="hidden mt-4">
                                <textarea id="creative-prompt" rows="4" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Mô tả ý tưởng của bạn... Ví dụ: tạo một chiếc đầm xòe dài qua gối, cổ vuông và tay phồng, sử dụng họa tiết hoa nhí từ ảnh gốc."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <div class="bg-gray-800 p-6 rounded-lg flex-grow flex flex-col justify-center text-center">
                             <div>
                                <i data-lucide="lightbulb" class="h-16 w-16 mx-auto mb-4 text-indigo-400"></i>
                                <h3 class="text-xl font-bold mb-4">Sẵn sàng Bắt đầu?</h3>
                                <p class="text-gray-400 mb-6">Tải lên ảnh và chọn chế độ. AI sẽ giúp bạn biến ý tưởng thành những thiết kế thời trang độc đáo.</p>
                            </div>
                            <button class="btn btn-primary w-full mt-auto" onclick="generateCreativeDesigns()">
                                <i data-lucide="wand-2" class="w-5 h-5 mr-2"></i>
                                Tạo Bộ Sưu Tập
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tool 6: Aspect Ratio Tool -->
            <div id="aspect-ratio-tool-container" class="hidden">
                <h2 class="text-3xl font-bold mb-6 text-center text-indigo-400">Công cụ Thay Đổi Tỷ Lệ Hàng Loạt</h2>
                <div class="grid md:grid-cols-2 gap-8 items-start">
                    <!-- Left Column: Inputs -->
                    <div class="space-y-6">
                        <div>
                            <h3 class="font-semibold mb-3 text-white">1. Tải lên Ảnh</h3>
                            <div class="file-input-wrapper" id="aspect-ratio-uploader">
                                <i data-lucide="upload-cloud" class="mx-auto h-12 w-12 text-gray-500"></i>
                                <span class="mt-2 block text-sm font-medium text-gray-300">Chọn một hoặc nhiều ảnh</span>
                                <input type="file" accept="image/*" multiple onchange="previewMultipleImages(event, 'aspect-ratio-previews-container')">
                                <div id="aspect-ratio-previews-container" class="mt-4 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2">
                                    <!-- Image previews will be dynamically inserted here -->
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold mb-3 text-white">2. Chọn Tỷ lệ Mới</h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4" data-group="aspect-ratio-select">
                                <div class="option-card selected" data-value="1/1" onclick="selectOne(this, 'aspect-ratio-select')"><i data-lucide="square" class="mx-auto h-8 w-8 mb-2"></i><span>Vuông (1:1)</span></div>
                                <div class="option-card" data-value="4/3" onclick="selectOne(this, 'aspect-ratio-select')"><i data-lucide="rectangle-horizontal" class="mx-auto h-8 w-8 mb-2"></i><span>Ngang (4:3)</span></div>
                                <div class="option-card" data-value="3/4" onclick="selectOne(this, 'aspect-ratio-select')"><i data-lucide="rectangle-vertical" class="mx-auto h-8 w-8 mb-2"></i><span>Dọc (3:4)</span></div>
                                <div class="option-card" data-value="16/9" onclick="selectOne(this, 'aspect-ratio-select')"><i data-lucide="monitor" class="mx-auto h-8 w-8 mb-2"></i><span>Rộng (16:9)</span></div>
                                <div class="option-card" data-value="9/16" onclick="selectOne(this, 'aspect-ratio-select')"><i data-lucide="smartphone" class="mx-auto h-8 w-8 mb-2"></i><span>Story (9:16)</span></div>
                            </div>
                        </div>
                        <button id="process-aspect-ratio-btn" class="btn btn-primary w-full" onclick="processAspectRatioChange()">
                            <i data-lucide="crop" class="w-5 h-5 mr-2"></i>
                            Cắt Ảnh Hàng Loạt
                        </button>
                    </div>
                    <!-- Right Column: Output -->
                    <div class="space-y-4">
                        <h3 class="font-semibold text-white">Kết quả:</h3>
                        <div id="aspect-ratio-results-container" class="bg-gray-800 p-4 rounded-lg min-h-[400px]">
                             <div class="text-center text-gray-500 flex flex-col justify-center items-center h-full">
                                 <i data-lucide="image" class="w-16 h-16 mx-auto mb-4"></i>
                                 <p>Các ảnh đã cắt sẽ xuất hiện ở đây.</p>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tool 7: Video Script Generator -->
            <div id="video-script-tool-container" class="hidden">
                 <h2 class="text-3xl font-bold mb-6 text-center text-indigo-400">Công cụ Tạo Kịch Bản Video từ Ảnh</h2>
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Inputs -->
                    <div class="space-y-6">
                        <div>
                             <h3 class="font-semibold mb-3 text-white">1. Tải lên các ảnh (theo thứ tự câu chuyện)</h3>
                            <div class="file-input-wrapper" id="video-script-uploader">
                                <i data-lucide="images" class="mx-auto h-12 w-12 text-gray-500"></i>
                                <span class="mt-2 block text-sm font-medium text-gray-300">Chọn nhiều ảnh để tạo câu chuyện</span>
                                <input type="file" accept="image/*" multiple onchange="previewMultipleImages(event, 'video-script-previews-container')">
                                <div id="video-script-previews-container" class="mt-4 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2">
                                    <!-- Image previews will be dynamically inserted here -->
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary w-full" onclick="generateVideoScript()">
                            <i data-lucide="pen-square" class="w-5 h-5 mr-2"></i>
                            Viết Kịch Bản
                        </button>
                    </div>
                    <!-- Output -->
                    <div class="bg-gray-800 p-6 rounded-lg flex flex-col min-h-[400px]">
                        <h3 class="font-semibold mb-3 text-white">2. Kịch bản Gợi ý (Có thể chỉnh sửa)</h3>
                        <div id="video-script-output-wrapper" class="flex-grow flex items-center justify-center rounded-lg bg-gray-900">
                             <div class="text-center text-gray-400 p-4">
                                 <i data-lucide="film" class="h-16 w-16 mx-auto mb-4"></i>
                                 <p>Kịch bản video của bạn sẽ xuất hiện ở đây.</p>
                             </div>
                        </div>
                        <textarea id="video-script-textarea" class="hidden w-full flex-grow bg-gray-900 border border-gray-600 rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500" rows="15" placeholder="Kịch bản video..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Tool 8: Face Swap (New Tool) -->
            <div id="face-swap-tool-container" class="hidden">
                 <h2 class="text-3xl font-bold mb-6 text-center text-indigo-400">Tạo ảnh với hình ảnh có sẵn</h2>
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Input Column -->
                    <div class="space-y-6">
                        <!-- Step 1: Inspiration -->
                        <div>
                            <h3 class="text-xl font-bold mb-2 text-gray-200">1. Lấy cảm hứng từ nhiều ảnh mẫu</h3>
                            <p class="text-sm text-gray-400 mb-3">Tải lên nhiều ảnh bạn thích (tối đa 6). AI sẽ tạo mô tả riêng cho từng ảnh.</p>
                            <div class="file-input-wrapper !p-3" id="style-multi-uploader-faceswap">
                                <i data-lucide="image-plus" class="mx-auto h-10 w-10 text-gray-500"></i>
                                <span class="mt-2 block text-sm font-medium text-gray-300">Chọn 1 hoặc nhiều ảnh mẫu...</span>
                                <input type="file" id="style-upload-faceswap-multi" multiple accept="image/*">
                                <div id="style-previews-container-faceswap" class="mt-4 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2">
                                </div>
                            </div>
                            <div class="mt-4">
                                <button id="generate-prompts-btn" class="btn btn-secondary w-full">
                                    <span id="generate-prompts-text">Tạo Mô Tả Từ Các Ảnh</span>
                                    <div id="generate-prompts-loader" class="hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                </button>
                            </div>
                            <div id="generated-prompts-log" class="mt-4 space-y-2 text-sm text-gray-300 bg-gray-800 p-3 rounded-lg hidden">
                            </div>
                        </div>

                        <!-- Step 2: Main Images -->
                        <div>
                            <h3 class="text-xl font-bold mb-2 text-gray-200">2. Tải lên ảnh của bạn</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="font-medium text-gray-300 block mb-2">Ảnh gương mặt</label>
                                    <div id="face-upload-box" class="upload-box upload-box-main">
                                        <div class="placeholder text-gray-400"><i data-lucide="user-round" class="w-12 h-12 mx-auto"></i><p class="mt-2 text-sm">Nhấn để tải lên</p></div>
                                        <img id="face-preview" class="hidden rounded-lg" alt="Xem trước gương mặt">
                                    </div>
                                    <input type="file" id="face-upload" class="hidden" accept="image/*">
                                </div>
                                <div>
                                    <label class="font-medium text-gray-300 block mb-2">Ảnh trang phục</label>
                                    <div id="outfit-upload-box-faceswap" class="upload-box upload-box-main">
                                         <div class="placeholder text-gray-400"><i data-lucide="shirt" class="w-12 h-12 mx-auto"></i><p class="mt-2 text-sm">Nhấn để tải lên</p></div>
                                        <img id="outfit-preview-faceswap" class="hidden rounded-lg" alt="Xem trước trang phục">
                                    </div>
                                    <input type="file" id="outfit-upload-faceswap" class="hidden" accept="image/*">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 3: Hair (Optional) -->
                        <div>
                            <h3 class="text-xl font-bold mb-2 text-gray-200">3. Thêm kiểu tóc (Tùy chọn)</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="font-medium text-gray-300 block mb-2">Tải ảnh kiểu tóc</label>
                                    <div id="hair-upload-box" class="upload-box !h-48">
                                         <div class="placeholder text-gray-400"><i data-lucide="image-up" class="w-12 h-12 mx-auto"></i><p class="mt-2 text-sm">Nhấn để tải lên</p></div>
                                        <img id="hair-preview" class="hidden rounded-lg" alt="Xem trước kiểu tóc">
                                    </div>
                                    <input type="file" id="hair-upload" class="hidden" accept="image/*">
                                </div>
                                <div class="relative flex py-2 items-center">
                                    <div class="flex-grow border-t border-gray-600"></div>
                                    <span class="flex-shrink mx-4 text-gray-400 text-sm">HOẶC</span>
                                    <div class="flex-grow border-t border-gray-600"></div>
                                </div>
                                <div>
                                    <label for="hair-description-input" class="font-medium text-gray-300 block mb-2">Mô tả kiểu tóc</label>
                                    <input type="text" id="hair-description-input" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ví dụ: tóc dài xoăn sóng màu nâu hạt dẻ, tóc bob ngắn cá tính...">
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: Prompt -->
                        <div>
                            <h3 class="text-xl font-bold mb-2 text-gray-200">4. Mô tả & Tinh chỉnh (Tùy chọn)</h3>
                            <p class="text-sm text-gray-400 mb-3">Dùng ô này nếu bạn chỉ muốn tạo một ảnh với mô tả của riêng mình (bỏ qua Bước 1).</p>
                            <textarea id="prompt" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" rows="4" placeholder="AI sẽ điền mô tả ở đây, hoặc bạn có thể tự viết..."></textarea>
                        </div>

                        <!-- Step 5: Generate -->
                        <div>
                            <h3 class="text-xl font-bold mb-2 text-gray-200">5. Bắt đầu tạo ảnh</h3>
                             <p class="text-sm text-gray-400 mb-3">AI sẽ tạo một ảnh cho mỗi mô tả đã được tạo ở Bước 1. Hoặc tạo một ảnh duy nhất từ mô tả ở Bước 4.</p>
                            <button id="generate-btn-faceswap" class="btn btn-primary w-full text-lg">Tạo ảnh</button>
                        </div>
                    </div>

                    <!-- Result Column -->
                    <div class="hidden lg:flex flex-col items-center justify-center bg-gray-800 rounded-2xl p-4 min-h-[400px] lg:min-h-full">
                        <div id="result-container-faceswap" class="w-full h-full flex flex-col items-center justify-center">
                            <div id="loader-faceswap" class="hidden mb-4 text-center">
                                <div class="loader mx-auto"></div>
                                <p class="text-gray-400 mt-2">AI đang sáng tạo, vui lòng chờ...</p>
                            </div>
                            <img id="result-image-faceswap" src="" alt="Kết quả tạo ảnh" class="hidden max-w-full max-h-full object-contain rounded-lg">
                            <div id="placeholder-result-faceswap" class="text-center text-gray-500">
                                 <i data-lucide="palette" class="w-20 h-20 mx-auto"></i>
                                 <p class="mt-4 text-lg">Kết quả của bạn sẽ xuất hiện ở đây</p>
                            </div>
                            <p id="error-message-faceswap" class="text-red-400 font-medium hidden text-center mt-4"></p>
                            <div id="result-actions-faceswap" class="hidden mt-4 flex space-x-4">
                                <button id="refine-btn-faceswap" class="btn btn-secondary"><i data-lucide="edit" class="w-5 h-5 mr-2"></i>Tinh chỉnh</button>
                                <a id="download-btn-faceswap" href="#" download="ai-fashion-image.png" class="btn btn-primary"><i data-lucide="download" class="w-5 h-5 mr-2"></i>Tải ảnh xuống</a>
                            </div>
                        </div>
                    </div>
                 </div>
            </div>

            <!-- NEW Tool 9: Vietnam Photoshoot -->
            <div id="vietnam-photoshoot-tool-container" class="hidden">
                 <div class="container mx-auto p-4 md:p-8 max-w-6xl">
                    <header class="text-center mb-8">
                        <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-teal-300">
                            AI Photoshoot Studio
                        </h1>
                        <p class="text-lg text-gray-400 mt-2">Tạo ảnh người mẫu tại các danh lam thắng cảnh Việt Nam</p>
                    </header>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                        <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                            <h2 class="text-xl font-semibold mb-3 text-blue-300">Bước 1: Tải ảnh chân dung</h2>
                            <div id="vn-face-preview" class="image-preview rounded-lg mb-4">
                                <span>Xem trước ảnh mặt</span>
                            </div>
                            <input type="file" id="vn-face-upload" accept="image/*" class="hidden">
                            <button id="vn-face-upload-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                Chọn ảnh
                            </button>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                            <h2 class="text-xl font-semibold mb-3 text-teal-300">Bước 2: Tải ảnh trang phục</h2>
                            <div id="vn-outfit-preview" class="image-preview rounded-lg mb-4">
                                <span>Xem trước trang phục</span>
                            </div>
                            <input type="file" id="vn-outfit-upload" accept="image/*" class="hidden">
                            <button id="vn-outfit-upload-btn" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                Chọn ảnh
                            </button>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                            <h2 class="text-xl font-semibold mb-3 text-green-300">Bước 3: Tải ảnh phụ kiện (Tùy chọn)</h2>
                            <div id="vn-accessory-preview" class="image-preview rounded-lg mb-4">
                                <span>Xem trước phụ kiện</span>
                            </div>
                            <input type="file" id="vn-accessory-upload" accept="image/*" class="hidden">
                            <button id="vn-accessory-upload-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                Chọn ảnh
                            </button>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 col-span-1 md:col-span-2 lg:col-span-3">
                            <h2 class="text-xl font-semibold mb-3 text-indigo-300">Bước 4: Tìm & Lưu địa điểm</h2>
                            <p class="text-gray-400 mb-4">Nhập địa danh, sau đó có thể lưu lại để dùng sau.</p>
                            <div class="flex gap-2">
                                <div class="relative flex-grow">
                                    <input type="text" id="vn-location-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ví dụ: Quảng trường Lâm Viên..." autocomplete="off">
                                    <div id="vn-suggestions-container" class="suggestions-list hidden"></div>
                                </div>
                                <button id="vn-save-location-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shrink-0">
                                    Lưu
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 mb-8">
                          <h2 class="text-xl font-semibold mb-3 text-purple-300">Bước 5: Thêm mô tả và tạo ảnh</h2>
                          <p class="text-gray-400 mb-4">Bạn có thể mô tả thêm về phong cách, ánh sáng hoặc hành động của người mẫu để AI tạo ảnh chính xác hơn. (Viết bằng tiếng Anh để có kết quả tốt nhất)</p>
                          <textarea id="vn-prompt-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white h-24 resize-none focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="e.g., golden hour lighting, cinematic style, looking at the camera..."></textarea>
                          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <button id="vn-generate-single-btn" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-300 transform hover:scale-105">
                                Tạo 1 ảnh AI
                            </button>
                            <button id="vn-generate-multiple-btn" class="w-full bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-300 transform hover:scale-105">
                                Tạo 5 ảnh với pose khác nhau
                            </button>
                        </div>
                    </div>
                    <div id="vn-result-section" class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 text-center" style="display: none;">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-200">Kết quả của bạn</h2>
                        <div id="vn-loader-container" class="flex justify-center items-center h-80">
                            <div class="vn-tool-loader"></div>
                            <p class="ml-4 text-gray-400">AI đang sáng tạo, vui lòng chờ trong giây lát...</p>
                        </div>
                        <div id="vn-single-image-result" class="hidden">
                            <div id="vn-single-image-container" class="aspect-ratio-container">
                                <img id="vn-result-image" src="" alt="Ảnh được tạo bởi AI">
                            </div>
                            <div class="flex justify-center gap-4 mt-4">
                                <button id="vn-download-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                    Tải ảnh
                                </button>
                                <button id="vn-edit-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                    Chỉnh sửa ảnh
                                </button>
                            </div>
                            <p id="vn-error-message" class="text-red-400 mt-4"></p>
                        </div>
                        <div id="vn-gallery-results" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mt-4 hidden">
                        </div>
                        <div id="vn-gallery-actions" class="flex justify-center gap-4 mt-4 hidden">
                            <button id="vn-download-selected-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                Tải ảnh đã chọn
                            </button>
                            <button id="vn-edit-selected-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                Chỉnh sửa ảnh đã chọn
                            </button>
                        </div>
                    </div>
                </div>
                 <div id="vn-alert-modal" class="modal-backdrop hidden">
                    <div class="vn-modal-content">
                        <button id="vn-alert-close-btn" class="modal-close-btn">&times;</button>
                        <p id="vn-alert-message" class="text-lg text-gray-300 mb-6"></p>
                        <button id="vn-alert-ok-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                            Đã hiểu
                        </button>
                    </div>
                </div>
                <div id="vn-edit-modal" class="modal-backdrop hidden">
                    <div class="vn-modal-content">
                        <button id="vn-edit-close-btn" class="modal-close-btn">&times;</button>
                        <h3 class="text-2xl font-semibold mb-4 text-gray-200">Chỉnh sửa ảnh</h3>
                        <p class="text-gray-400 mb-4">Mô tả những gì bạn muốn thêm hoặc bớt trên ảnh. (Viết bằng tiếng Anh để có kết quả tốt nhất)</p>
                        <textarea id="vn-edit-prompt-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white h-24 resize-none focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="e.g., add a pair of sunglasses, remove the background, make her smile..."></textarea>
                        <button id="vn-confirm-edit-btn" class="w-full mt-4 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                            Xác nhận chỉnh sửa
                        </button>
                    </div>
                </div>
                <div id="vn-image-viewer-modal" class="modal-backdrop hidden">
                    <button id="vn-viewer-close-btn" class="modal-close-btn" style="top: 20px; right: 30px; font-size: 2.5rem; color: white;">&times;</button>
                    <img id="vn-enlarged-image" src="" alt="Ảnh phóng to" class="max-w-[90vw] max-h-[90vh] object-contain rounded-lg">
                </div>
            </div>

            <!-- Universal Result Section -->
            <div id="result-section" class="hidden text-center">
                 <h2 id="result-header" class="text-3xl font-bold mb-4 text-indigo-400">Đang tạo hình ảnh...</h2>
                 <p id="result-subheader" class="text-gray-400 mb-8">Vui lòng chờ trong giây lát. Trợ lý AI đang làm việc với những lựa chọn của bạn.</p>
                 <div id="result-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                 <div class="flex justify-center items-center space-x-4 mt-8">
                    <button id="back-to-edit-btn" class="hidden btn btn-secondary" onclick="backToEdit()"><i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i><span>Quay lại chỉnh sửa</span></button>
                    <button id="restart-btn" class="hidden btn btn-primary" onclick="regenerateAllNew()"><i data-lucide="refresh-cw" class="w-5 h-5 mr-2"></i><span>Tạo ảnh mới</span></button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="custom-modal" class="modal-overlay"><div class="modal-content"><p id="modal-message" class="text-lg mb-6"></p><button class="btn btn-primary" onclick="closeModal('custom-modal')">Đã hiểu</button></div></div>
    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content text-left max-w-2xl">
            <h3 class="text-xl font-bold mb-4">Chỉnh sửa & Tạo lại</h3>
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <p class="text-sm font-semibold text-gray-400 mb-2">Ảnh Gốc</p>
                    <img id="edit-modal-img" class="rounded-lg w-full object-cover aspect-[2/3]">
                </div>
                <div>
                    <p class="text-sm font-semibold text-gray-400 mb-2">Mô tả chi tiết</p>
                    <textarea id="edit-prompt-textarea" rows="8" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 text-sm"></textarea>
                    <p class="text-sm font-semibold text-gray-400 mt-3 mb-2">Yêu cầu thay đổi</p>
                    <textarea id="edit-changes-textarea" rows="4" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 text-sm" placeholder="Ví dụ: thêm một chiếc vòng cổ, đổi màu tóc thành vàng, làm cho hậu cảnh mờ hơn..."></textarea>
                </div>
            </div>
            <input type="hidden" id="edit-modal-index">
            <input type="hidden" id="edit-modal-tool">
            <div class="flex justify-end space-x-4 mt-6">
                <button class="btn btn-secondary" onclick="closeModal('edit-modal')">Hủy</button>
                <button class="btn btn-primary" onclick="regenerateFromModal()"><i data-lucide="wand-2" class="w-5 h-5 mr-2"></i><span>Tạo lại</span></button>
            </div>
        </div>
    </div>

    <!-- Image Viewer Modal -->
    <div id="image-viewer-modal" class="modal-overlay" onclick="closeModal('image-viewer-modal')">
        <div class="p-4 w-full h-full flex items-center justify-center">
            <img id="viewer-img" src="" alt="Xem ảnh lớn" class="max-w-[90vw] max-h-[90vh] object-contain rounded-lg shadow-2xl" onclick="event.stopPropagation()">
            <button class="absolute top-4 right-4 text-white bg-black/50 rounded-full p-2 hover:bg-black/80 transition-colors" onclick="closeModal('image-viewer-modal')">
                <i data-lucide="x" class="w-8 h-8"></i>
            </button>
        </div>
    </div>

    <!-- Refinement Modal for Face Swap Tool -->
    <div id="refine-modal-faceswap" class="modal-overlay">
        <div class="modal-content text-left">
            <h3 class="text-xl font-bold mb-4">Tinh chỉnh hình ảnh</h3>
            <input type="hidden" id="refine-index-faceswap">
            <p class="text-sm text-gray-400 mb-4">Nhập mô tả các thay đổi bạn muốn, ví dụ: "thêm một chiếc kính râm" hoặc "đổi màu áo thành màu xanh lá cây".</p>
            <textarea id="refine-prompt-faceswap" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500" rows="3" placeholder="Mô tả thay đổi..."></textarea>
            <div class="mt-4 flex justify-end space-x-3">
                <button id="cancel-refine-btn-faceswap" class="btn btn-secondary" onclick="closeModal('refine-modal-faceswap')">Hủy</button>
                <button id="submit-refine-btn-faceswap" class="btn btn-primary" onclick="regenerateFaceSwapFromModal()">
                     <span id="submit-refine-text-faceswap">Tạo lại</span>
                     <div id="submit-refine-loader-faceswap" class="hidden ml-2 w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- State Management ---
        let currentStep = 1;
        const totalSteps = 7;
        let savedImageParts = [];
        let finalPrompts = [];
        let currentBasePrompt = '';
        let activeTool = null;
        let productInputMode = 'text';
        let designInputMode = 'color';
        let creativeInputMode = 'auto';
        let isolatedProductImagePart = null;
        let originalProductImagePart = null;
        let promptImageDescriptions = [];
        let isFaceSwapToolInitialized = false;
        let isVnToolInitialized = false;

        // --- Globals for Face Swap Tool ---
        let faceSwap_Prompts = [];
        let faceSwap_FaceFile = null;
        let faceSwap_OutfitFile = null;
        let faceSwap_HairFile = null;
        let faceSwap_HairDescription = '';
        let faceSwap_FaceBase64 = null;
        let faceSwap_OutfitBase64 = null;
        let faceSwap_HairBase64 = null;

        // --- Helper Function ---
        function safeCreateIcons(options) {
            // Thêm bước kiểm tra "sâu" hơn: đảm bảo 'lucide.icons' tồn tại VÀ có nội dung
            if (typeof lucide !== 'undefined' && 
                typeof lucide.createIcons === 'function' &&
                lucide.icons && // <-- Kiểm tra xem đối tượng 'icons' đã được nạp chưa
                Object.keys(lucide.icons).length > 0 // <-- Kiểm tra xem nó có rỗng không
            ) {
                try {
                    if (options) {
                        lucide.createIcons(options);
                    } else {
                        lucide.createIcons();
                    }
                } catch (e) {
                    // Ghi lại lỗi nếu hàm createIcons bị lỗi nội bộ
                    console.warn(`Lucide.createIcons() call failed internally:`, e);
                }
            } else {
                // Log a warning if lucide isn't ready. This avoids crashing the app.
                console.warn("Lucide library not ready, icons may not render immediately.");
            }
        }

        // ĐÃ XÓA hàm runInitialIconCreation() gây lỗi.


        window.addEventListener('load', () => {
            // Đơn giản hóa: Chỉ cần gọi safeCreateIcons sau khi trang load
            // Thêm một độ trễ nhỏ để đảm bảo script lucide chạy xong.
            setTimeout(() => {
                safeCreateIcons();
                console.log("Attempted to initialize Lucide icons on load.");
            }, 100); // Đợi 100ms sau khi MỌI THỨ đã tải

            const colorPicker = document.getElementById('design-color-picker');
            const colorPromptTextarea = document.getElementById('design-color-prompt');
            if(colorPicker && colorPromptTextarea) {
                colorPicker.addEventListener('input', (e) => {
                    colorPromptTextarea.value = `màu ${e.target.value}`;
                });
            }

            showToolSelection();
        });


        // --- UI Control Functions ---
        function showToolSelection() {
            document.getElementById('tool-selection').style.display = 'block';
            const tools = ['model', 'product', 'design', 'creative-design', 'accessory', 'video-script', 'face-swap', 'aspect-ratio', 'vietnam-photoshoot'];
            tools.forEach(tool => {
                const container = document.getElementById(`${tool}-tool-container`);
                if (container) container.style.display = 'none';
            });
            document.getElementById('result-section').style.display = 'none';
            document.getElementById('back-to-selection-btn').classList.add('hidden');
            document.getElementById('header-subtitle').style.display = 'block';
            activeTool = null;
        }

        function selectTool(toolName) {
            activeTool = toolName;
            document.getElementById('tool-selection').style.display = 'none';
            document.getElementById('header-subtitle').style.display = 'none';
            document.getElementById('back-to-selection-btn').classList.remove('hidden');
            const tools = ['model', 'product', 'design', 'creative-design', 'accessory', 'video-script', 'face-swap', 'aspect-ratio', 'vietnam-photoshoot'];
            tools.forEach(tool => {
                const container = document.getElementById(`${tool}-tool-container`);
                 if (container) container.style.display = tool === toolName ? 'block' : 'none';
            });
            if (toolName === 'face-swap' && !isFaceSwapToolInitialized) {
                initializeFaceSwapTool();
                isFaceSwapToolInitialized = true;
            }
            if (toolName === 'vietnam-photoshoot' && !isVnToolInitialized) {
                initializeVietnamPhotoshootTool();
                isVnToolInitialized = true;
            }
        }

        function showModal(id, message) {
            const modal = document.getElementById(id);
            if (message) document.getElementById('modal-message').textContent = message;
            modal.classList.add('visible');
        }
        function closeModal(id) { document.getElementById(id).classList.remove('visible'); }

        function switchProductInput(mode) {
            productInputMode = mode;
            document.getElementById('product-text-input').classList.toggle('hidden', mode !== 'text');
            document.getElementById('product-ref-input').classList.toggle('hidden', mode !== 'ref');
            document.getElementById('tab-text').classList.toggle('border-indigo-500', mode === 'text');
            document.getElementById('tab-ref').classList.toggle('border-indigo-500', mode === 'ref');
        }
         function switchDesignInput(mode) {
            designInputMode = mode;
            document.getElementById('design-color-input').classList.toggle('hidden', mode !== 'color');
            document.getElementById('design-fabric-input').classList.toggle('hidden', mode !== 'fabric');
            document.getElementById('tab-color').classList.toggle('border-indigo-500', mode === 'color');
            document.getElementById('tab-fabric').classList.toggle('border-indigo-500', mode === 'fabric');
        }
        function switchCreativeInput(mode) {
            creativeInputMode = mode;
            document.getElementById('creative-auto-input').classList.toggle('hidden', mode !== 'auto');
            document.getElementById('creative-manual-input').classList.toggle('hidden', mode !== 'manual');
            document.getElementById('tab-auto').classList.toggle('border-indigo-500', mode === 'auto');
            document.getElementById('tab-manual').classList.toggle('border-indigo-500', mode === 'manual');
        }
        
        function openImageModal(imageUrl) {
            document.getElementById('viewer-img').src = imageUrl;
            const modal = document.getElementById('image-viewer-modal');
            modal.classList.add('visible');
            // Ensure the close icon is rendered
            safeCreateIcons({nodes: modal.querySelectorAll('[data-lucide]')}); // Use the safe function
        }
        
        function previewImage(event, previewId) {
            const reader = new FileReader();
            const preview = document.getElementById(previewId);
            const uploader = preview.parentElement;
            reader.onload = () => {
                preview.src = reader.result;
                preview.classList.remove('hidden');
                if(uploader.querySelector('span')) uploader.querySelector('span').style.display = 'none';
                if(uploader.querySelector('i, svg')) uploader.querySelector('i, svg').style.display = 'none';
            }
            reader.readAsDataURL(event.target.files[0]);
        }

        // --- Model Tool Specific Functions ---
        function updateUI() {
            document.querySelectorAll('#model-tool-container .step-card').forEach(step => {
                step.classList.toggle('active', parseInt(step.id.split('-')[1]) === currentStep);
            });
            document.getElementById('progress-bar').style.width = `${(currentStep / totalSteps) * 100}%`;
            document.getElementById('prev-btn').disabled = currentStep === 1;
            document.getElementById('next-btn').classList.toggle('hidden', currentStep === totalSteps);
            document.getElementById('generate-btn').classList.toggle('hidden', currentStep !== totalSteps);
        }
        function changeStep(direction) {
            if (direction > 0 && currentStep === 1 && (document.querySelector('#model-uploader input').files.length === 0 || document.querySelector('#outfit-uploader input').files.length === 0)) {
                showModal('custom-modal', 'Vui lòng tải lên ít nhất Ảnh Người Mẫu và Ảnh Trang Phục.'); return;
            }
            currentStep = Math.max(1, Math.min(totalSteps, currentStep + direction));
            updateUI();
        }
        function toggleSelection(element) { element.classList.toggle('selected'); }
        function selectOne(element, group) {
            document.querySelectorAll(`[data-group="${group}"] .option-card`).forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
        }
        
        function removeOption(element) {
            element.remove();
        }

        function addCustomOption(group, displayName = null, dataValue = null) {
            let finalDisplayName, finalDataValue;
            const grid = document.querySelector(`[data-group="${group}"]`);

            if (displayName === null) { // Manual mode from input field
                const input = document.getElementById(`custom-${group}-input`);
                const value = input.value.trim();
                if (!value) {
                showModal('custom-modal', 'Vui lòng nhập một giá trị.');
                return;
            }
            finalDisplayName = value;
            finalDataValue = value.toLowerCase();
            input.value = '';
        } else { // Programmatic mode (e.g., from save background)
                finalDisplayName = displayName;
                finalDataValue = dataValue;
            }
            
            // Check for duplicates
            const existing = grid.querySelector(`[data-value="${finalDataValue}"]`);
            if (existing) {
                showModal('custom-modal', 'Tùy chọn này đã tồn tại.');
                return;
            }

            const newCard = document.createElement('div');
            newCard.className = 'option-card';
            newCard.dataset.value = finalDataValue;
            newCard.onclick = () => selectOne(newCard, group);

            const textNode = document.createTextNode(finalDisplayName);
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = '&times;';
            removeBtn.onclick = (event) => {
                event.stopPropagation();
                removeOption(newCard);
            };

            newCard.appendChild(textNode);
            newCard.appendChild(removeBtn);
            grid.appendChild(newCard);
        }

        function previewMultipleImages(event, previewContainerId) {
            const container = document.getElementById(previewContainerId);
            const uploader = container.closest('.file-input-wrapper');
            container.innerHTML = ''; // Clear previous previews

            const files = event.target.files;
            if (files.length > 0) {
                uploader.querySelector('i, svg').style.display = 'none';
                uploader.querySelector('span').style.display = 'none';

                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imgWrapper = document.createElement('div');
                        imgWrapper.className = 'relative aspect-square rounded-md overflow-hidden animate-fade-in';
                        imgWrapper.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                        container.appendChild(imgWrapper);
                    };
                    reader.readAsDataURL(file);
                });
            } else {
                // No files selected, show the icon and text again
                uploader.querySelector('i, svg').style.display = 'block';
                uploader.querySelector('span').style.display = 'block';
            }
        }

        function generateWithIdea() {
            const idea = document.getElementById('ai-idea-prompt').value.trim();
            if (!idea) {
                showModal('custom-modal', 'Vui lòng nhập ý tưởng của bạn vào ô trống.');
                return;
            }
            if (document.querySelector('#model-uploader input').files.length === 0 || document.querySelector('#outfit-uploader input').files.length === 0) {
                showModal('custom-modal', 'Vui lòng tải lên Ảnh Người Mẫu và Trang Phục trước.');
                return;
            }

            const customPrompt = `AI ASSISTANT: You have creative freedom but you must follow the user's core idea. \n- USER'S CORE IDEA: ${idea}. \n- Your task is to expand on this idea. Choose the best combination of pose, hair, background, and lighting to create a stunning, professional photograph that perfectly captures the user's concept.`;
            generateImages('custom', customPrompt, true);
        }

        async function getAISuggestions() {
            if (document.querySelector('#model-uploader input').files.length === 0 || document.querySelector('#outfit-uploader input').files.length === 0) {
                showModal('custom-modal', 'Vui lòng tải lên Ảnh Người Mẫu và Trang Phục trước khi nhận gợi ý.');
                return;
            }

            const btn = document.getElementById('get-suggestions-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loader mx-auto"></div>';
            
            const suggestionsContainer = document.getElementById('suggestions-container');
            suggestionsContainer.innerHTML = '';
            suggestionsContainer.classList.add('hidden');

            try {
                const textGenApiKey = "AIzaSyAAgKXiYFW4-ANBJ08W39gj_vHvhBSD6kQ";
                const textGenApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${textGenApiKey}`;

                const modelFile = document.querySelector('#model-uploader input').files[0];
                const outfitFile = document.querySelector('#outfit-uploader input').files[0];
                const imagePromises = [fileToBase64(modelFile), fileToBase64(outfitFile)];
                const resolvedImages = await Promise.all(imagePromises);
                const imagePartsForText = resolvedImages.map(img => ({ inlineData: img }));

                const systemPrompt = `You are a creative director for a fashion photoshoot. Based on the two images provided (a model and an outfit), generate three distinct and creative photoshoot concepts. Each concept should be a concise, engaging sentence in Vietnamese. Return the concepts as a JSON array of strings. Example format: ["Concept 1", "Concept 2", "Concept 3"]`;
                
                const payload = {
                    contents: [{ parts: [{ text: "Please generate 3 concepts based on these images." }, ...imagePartsForText] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { responseMimeType: "application/json" }
                };

                const response = await fetch(textGenApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                
                const result = await response.json();
                const textResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!textResponse) throw new Error("No suggestions returned from AI.");
                
                const suggestions = JSON.parse(textResponse);

                if (!Array.isArray(suggestions) || suggestions.length === 0) {
                    throw new Error("Invalid suggestions format.");
                }

                suggestions.forEach(suggestion => {
                    const suggestionEl = document.createElement('div');
                    suggestionEl.className = 'bg-gray-900 p-3 rounded-lg flex items-center justify-between text-left';
                    suggestionEl.innerHTML = `
                        <p class="text-sm text-gray-300 flex-1 pr-3">${suggestion}</p>
                        <button class="btn btn-primary btn-sm whitespace-nowrap">Chọn</button>
                    `;
                    suggestionEl.querySelector('button').onclick = () => {
                        const suggestionPrompt = `AI ASSISTANT: Execute the following creative concept perfectly. \n- CONCEPT: ${suggestion}. \n- Your task is to bring this concept to life. Choose the best combination of pose, hair, background, and lighting to create a stunning, professional photograph that matches the selected concept.`;
                        generateImages('custom', suggestionPrompt, true);
                    };
                    suggestionsContainer.appendChild(suggestionEl);
                });
                
                suggestionsContainer.classList.remove('hidden');

            } catch (error) {
                console.error("Error getting AI suggestions:", error);
                showModal('custom-modal', 'Đã có lỗi xảy ra khi lấy gợi ý từ AI. Vui lòng thử lại.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Nhận 3 Gợi Ý Chụp Ảnh';
            }
        }


        // --- General & Utility Functions ---
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve({ mimeType: file.type, data: reader.result.split(',')[1] });
                reader.onerror = error => reject(error);
            });
        }

        function showResultScreen() {
             const tools = ['model', 'product', 'design', 'creative-design', 'accessory', 'video-script', 'face-swap', 'aspect-ratio'];
             tools.forEach(tool => { 
                const container = document.getElementById(`${tool}-tool-container`);
                if(container) container.style.display = 'none'; 
             });
             const resultSection = document.getElementById('result-section');
             resultSection.classList.remove('hidden');
             resultSection.style.display = 'block';
             document.getElementById('result-header').textContent = 'Đang tạo hình ảnh...';
             document.getElementById('result-subheader').textContent = 'Vui lòng chờ trong giây lát. Trợ lý AI đang làm việc...';
             document.getElementById('result-grid').innerHTML = '';
             document.getElementById('back-to-edit-btn').classList.add('hidden');
             document.getElementById('restart-btn').classList.add('hidden');
        }

        function backToEdit() {
            document.getElementById('result-section').style.display = 'none';
            document.getElementById(`${activeTool}-tool-container`).style.display = 'block';
            if (activeTool === 'model') {
                document.getElementById('manual-steps').style.display = 'block';
                document.getElementById('nav-buttons').style.display = 'flex';
                 currentStep = 3;
                 updateUI();
            }
        }
        
        async function regenerateAllNew() {
            const btn = document.getElementById('restart-btn');
            const originalBtnContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<div class="loader" style="width: 20px; height: 20px; border-width: 2px;"></div><span class="ml-2">Đang nghĩ ý tưởng...</span>`;

            try {
                const textGenApiKey = "AIzaSyAAgKXiYFW4-ANBJ08W39gj_vHvhBSD6kQ";
                const textGenApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${textGenApiKey}`;
                
                const conceptGenerationPrompt = "Generate one single, highly creative, and visually stunning fashion photoshoot concept, described in a single concise sentence in English. The concept should be set in a specific and interesting location anywhere in the world. Be very specific about the location and the mood. For example: 'A dramatic photoshoot at the Vasquez Rocks in California during a fiery sunset.' or 'An ethereal, misty morning shoot in the ancient bamboo forests of Arashiyama, Kyoto.'";

                const payload = {
                    contents: [{ parts: [{ text: conceptGenerationPrompt }] }]
                };
                
                const response = await fetch(textGenApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('Failed to generate a new concept.');
                
                const result = await response.json();
                const newConcept = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!newConcept || newConcept.trim() === '') {
                    throw new Error('AI returned an empty concept.');
                }
                
                const regenerationPrompt = `AI ASSISTANT: REGNERATE a completely new set of 5 images based on a fresh, creative concept. The model must wear the same outfit. Everything else (pose, location, lighting, style) should be brand new, inspired by the following highly creative and unique theme. You must create a full, detailed scene based on this concept.\n\n- THEME: **${newConcept.trim()}**`;
                
                generateImages('custom', regenerationPrompt, false);
                btn.disabled = false;
                btn.innerHTML = originalBtnContent;

            } catch (error) {
                console.error("Error in regenerateAllNew:", error);
                showModal('custom-modal', 'Không thể tạo ý tưởng mới. Vui lòng thử lại.');
                btn.disabled = false;
                btn.innerHTML = originalBtnContent;
            }
        }
        
        async function regenerateVariations(baseImageIndex) {
            const basePromptForVariation = finalPrompts[baseImageIndex];
            const coreConceptPrompt = basePromptForVariation.substring(0, basePromptForVariation.lastIndexOf('\n- ')).trim();

            showResultScreen();
            document.getElementById('result-header').textContent = 'Tạo các phiên bản mới...';
            document.getElementById('result-subheader').textContent = 'AI đang sáng tạo các góc chụp và dáng pose mới cho concept của bạn.';

            const variationModifiers = [
                { title: 'Góc Thấp', modifier: 'Dynamic walking pose, low angle full body shot, looking towards the camera.' },
                { title: 'Góc Cao', modifier: 'Sitting pose on a stylish chair, high angle medium shot, soft smile.' },
                { title: 'Chuyển động', modifier: 'Candid shot, model is turning around, capturing the movement of the outfit, dutch angle.' },
                { title: 'Tương tác', modifier: 'Model is interacting with an object in the scene (e.g., holding a coffee cup, touching a flower), close-up shot.' },
                { title: 'Tối giản', modifier: 'Model standing against a clean, minimalist background, looking away from camera, balanced composition.' }
            ];

            const resultGrid = document.getElementById('result-grid');
            const newPrompts = [];
            variationModifiers.forEach(vm => {
                newPrompts.push(`${coreConceptPrompt}\n- ${vm.modifier}`);
                const placeholder = document.createElement('div');
                placeholder.className = 'result-image-wrapper flex flex-col items-center justify-center aspect-[2/3]';
                placeholder.innerHTML = `<div class="loader"></div><p class="mt-4 text-sm text-gray-400">${vm.title}</p>`;
                resultGrid.appendChild(placeholder);
            });
            finalPrompts = newPrompts;
            
            let successfulImages = 0;
            const generationPromises = finalPrompts.map((p, i) => generateSingleImage(i, p, 'model').then(s => { if (s) successfulImages++; }));
            await Promise.all(generationPromises);

            document.getElementById('result-header').textContent = `Hoàn thành! (${successfulImages}/${variationModifiers.length})`;
            document.getElementById('result-subheader').textContent = 'Đây là các phiên bản mới cho concept bạn đã chọn.';
            document.getElementById('restart-btn').classList.remove('hidden');
            document.getElementById('back-to-edit-btn').classList.remove('hidden');
        }

        async function saveBackground(index) {
            const prompt = finalPrompts[index];
            if (!prompt) {
                showModal('custom-modal', 'Không thể tìm thấy thông tin bối cảnh.');
                return;
            }

            try {
                const match = prompt.match(/- Location: (.*?)\n/s);
                let locationValue;
                let friendlyName;

                if (match && match[1]) {
                    locationValue = match[1].trim().replace(/\.$/, '');
                } else {
                    showModal('custom-modal', 'Đang dùng AI để trích xuất bối cảnh, vui lòng chờ...');
                    const textGenApiKey = "AIzaSyAAgKXiYFW4-ANBJ08W39gj_vHvhBSD6kQ";
                    const textGenApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${textGenApiKey}`;
                    const extractionPrompt = `From the following fashion photoshoot description, extract only the location description in 3-5 Vietnamese words. Be concise and descriptive. Do not add any prefixes like "Bối cảnh:".\n\nDescription:\n"${prompt}"`;
                    
                    const payload = { contents: [{ parts: [{ text: extractionPrompt }] }] };
                    
                    const response = await fetch(textGenApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error('AI extraction failed');
                    const result = await response.json();
                    const extractedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!extractedText) throw new Error('AI did not return text');
                    locationValue = extractedText.trim();
                }

                friendlyName = locationValue.replace(/^(in a|on a|with|at a|tại|trong|ở)\s+/i, '');
                friendlyName = friendlyName.charAt(0).toUpperCase() + friendlyName.slice(1);
                
                addCustomOption('background', friendlyName, locationValue);
                closeModal('custom-modal');
                showModal('custom-modal', `Bối cảnh "${friendlyName}" đã được lưu vào Bước 5.`);

            } catch (error) {
                console.error("Failed to save background:", error);
                closeModal('custom-modal');
                showModal('custom-modal', 'Không thể tự động trích xuất bối cảnh từ ảnh này.');
            }
        }

        // --- Accessory Tool Functions ---
        async function processProductForAccessories() {
            const productFile = document.querySelector('#accessory-product-uploader input').files[0];
            if (!productFile) {
                showModal('custom-modal', 'Vui lòng tải lên ảnh sản phẩm.');
                return;
            }

            const btn = document.getElementById('process-product-btn');
            const originalBtnContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<div class="loader" style="width: 20px; height: 20px; border-width: 2px;"></div><span class="ml-2">Đang xử lý...</span>`;

            document.getElementById('product-display-wrapper').classList.remove('hidden');
            const productDisplay = document.getElementById('product-display');
            productDisplay.innerHTML = `<div class="loader"></div>`;
            document.getElementById('accessory-generation-wrapper').classList.add('hidden');
            
            try {
                originalProductImagePart = { inlineData: await fileToBase64(productFile) };
                
                const apiKey = "AIzaSyAAgKXiYFW4-ANBJ08W39gj_vHvhBSD6kQ";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                const prompt = "Your task is to perfectly isolate only the main clothing item from the uploaded image. If there is a person wearing the clothing, you must remove the person entirely. The output should be a photorealistic image of just the clothing item itself, as if it's a 'ghost mannequin' or 'flat lay' product shot, on a clean, solid white background. Ensure the edges are clean and the entire product is visible without any parts of the person.";
                const payload = { 
                    contents: [{ parts: [{ text: prompt }, originalProductImagePart] }], 
                    generationConfig: { responseModalities: ['IMAGE'] } 
                };

                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);

                const result = await response.json();
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                if (!base64Data) throw new Error("No image data returned from background removal.");

                const mimeType = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.mimeType || 'image/png';
                isolatedProductImagePart = { inlineData: { mimeType: mimeType, data: base64Data } };

                const imageUrl = `data:${mimeType};base64,${base64Data}`;
                const filename = `san-pham-tach-nen.png`;
                productDisplay.innerHTML = `
                    <img src="${imageUrl}" alt="Sản phẩm đã tách nền" class="w-full h-full object-contain animate-fade-in">
                    <div class="absolute top-2 right-2 z-10">
                        <a href="${imageUrl}" download="${filename}" class="bg-black/60 p-2 rounded-full text-white hover:bg-indigo-500 inline-flex" title="Tải về">
                            <i data-lucide="download" class="w-5 h-5"></i>
                        </a>
                    </div>
                `;
                
                document.getElementById('accessory-generation-wrapper').classList.remove('hidden');
                safeCreateIcons(); // Use the safe function

            } catch (error) {
                console.error("Error processing product:", error);
                productDisplay.innerHTML = `<div class="p-4 text-center text-red-400"><i data-lucide="alert-triangle" class="w-8 h-8 mx-auto"></i><p class="text-sm mt-2">Lỗi tách nền</p></div>`;
                safeCreateIcons({nodes: productDisplay.querySelectorAll('[data-lucide]')}); // Use the safe function
                showModal('custom-modal', 'Đã xảy ra lỗi khi tách nền sản phẩm. Vui lòng thử lại.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnContent;
                safeCreateIcons(); // Use the safe function
            }
        }

        async function generateAccessories() {
            if (!originalProductImagePart) {
                showModal('custom-modal', 'Lỗi: Không tìm thấy ảnh sản phẩm gốc. Vui lòng bắt đầu lại.');
                return;
            }

            const btn = document.getElementById('generate-accessories-btn');
            const originalBtnContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<div class="loader" style="width: 20px; height: 20px; border-width: 2px;"></div><span class="ml-2">Đang sáng tạo...</span>`;

            const accessoryDisplay = document.getElementById('accessory-display');
            accessoryDisplay.innerHTML = `<div class="loader"></div>`;

            try {
                const apiKey = "AIzaSyAAgKXiYFW4-ANBJ08W39gj_vHvhBSD6kQ";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                const prompt = `You are a professional fashion stylist. Based on the clothing item in the user's provided image, create a photorealistic 'flat lay' image showcasing a set of 4 matching accessories that would complement the outfit perfectly. The accessories should include a handbag, a pair of shoes, a necklace, and a bracelet. The accessories must be stylish and appropriate for the clothing. Arrange them elegantly on a clean, minimalist, solid light gray background. Do not include the original clothing item in the final image.`;
                
                const payload = { 
                    contents: [{ parts: [{ text: prompt }, originalProductImagePart] }], 
                    generationConfig: { responseModalities: ['IMAGE'] } 
                };

                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
                
                const result = await response.json();
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                if (!base64Data) throw new Error("No image data returned from accessory generation.");

                const mimeType = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.mimeType || 'image/png';
                const imageUrl = `data:${mimeType};base64,${base64Data}`;
                const filename = `phu-kien-goi-y.png`;
                
                accessoryDisplay.innerHTML = `
                    <img src="${imageUrl}" alt="Phụ kiện gợi ý" class="w-full h-full object-cover animate-fade-in">
                    <div class="absolute top-2 right-2 z-10">
                        <a href="${imageUrl}" download="${filename}" class="bg-black/60 p-2 rounded-full text-white hover:bg-indigo-500 inline-flex" title="Tải về">
                            <i data-lucide="download" class="w-5 h-5"></i>
                        </a>
                    </div>
                `;
                
                btn.innerHTML = `<i data-lucide="refresh-cw" class="w-5 h-5 mr-2"></i> Tạo lại bộ khác`;

            } catch (error) {
                console.error("Error generating accessories:", error);
                accessoryDisplay.innerHTML = `<div class="p-4 text-center text-red-400"><i data-lucide="alert-triangle" class="w-8 h-8 mx-auto"></i><p class="text-sm mt-2">Lỗi tạo phụ kiện</p></div>`;
                showModal('custom-modal', 'Đã có lỗi xảy ra khi tạo phụ kiện. Vui lòng thử lại.');
                 btn.innerHTML = originalBtnContent;
            }
        }


        // --- Image Generation Logic ---
        async function generateVideoScript() {
            const imageFiles = document.querySelector('#video-script-uploader input').files;
            if (imageFiles.length === 0) {
                showModal('custom-modal', 'Vui lòng tải lên ít nhất một ảnh để tạo kịch bản.');
                return;
            }

            const outputWrapper = document.getElementById('video-script-output-wrapper');
            const textarea = document.getElementById('video-script-textarea');
            outputWrapper.classList.remove('hidden');
            outputWrapper.innerHTML = '<div class="loader"></div><p class="mt-4 text-sm text-gray-300">AI đang viết kịch bản...</p>';
            textarea.classList.add('hidden');

            try {
                const imagePromises = Array.from(imageFiles).map(file => fileToBase64(file));
                const resolvedImages = await Promise.all(imagePromises);
                const imageParts = resolvedImages.map(img => ({ inlineData: img }));

                const textGenApiKey = "gen-lang-client-0522308425"; 
                const textGenApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${textGenApiKey}`;

                const systemPrompt = `You are a professional video director and scriptwriter specializing in short, impactful social media ads. Your task is to create a cohesive video script based on the sequence of images provided by the user. The script should tell a single, continuous story.

Each image represents one scene. Each scene should be approximately 5 seconds long, so keep the descriptions concise and impactful.

For each image in the provided sequence, you MUST generate a corresponding scene description. Follow this exact format in Vietnamese for every scene:

**Cảnh [Number]: [A short, descriptive title for the scene]**
* **Góc máy:** [Describe the camera angle and shot type, e.g., "Cận cảnh (Close-up) vào chi tiết sản phẩm", "Toàn cảnh (Wide shot) người mẫu bước đi"]
* **Hành động:** [Describe the action, e.g., "Người mẫu xoay người nhẹ nhàng.", "Sản phẩm được đặt lên bàn."]
* **Biểu cảm:** [Describe the model's expression. If no model, write "Không áp dụng.", e.g., "Tự tin và cuốn hút."]
* **Prompt Gợi ý (tạo video):** [Create a detailed, single-paragraph text-to-video prompt in English for this scene. Example: "A cinematic close-up shot of a woman's hand gently touching a silk dress, soft morning light, warm and elegant mood, photorealistic, 8K."]

Ensure the entire output is in Vietnamese, except for the "Prompt Gợi ý". The story must flow logically from the first image to the last.`;

                const payload = {
                    contents: [{ 
                        parts: [
                            { text: "Please generate a video script that tells a story connecting these images in order." }, 
                            ...imageParts 
                        ] 
                    }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };

                const response = await fetch(textGenApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const result = await response.json();
                const textResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!textResponse) throw new Error("No script returned from AI.");

                outputWrapper.classList.add('hidden');
                textarea.value = textResponse.trim();
                textarea.classList.remove('hidden');
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight) + 'px';
                textarea.addEventListener('input', () => {
                    textarea.style.height = 'auto';
                    textarea.style.height = (textarea.scrollHeight) + 'px';
                }, false);


            } catch (error) {
                console.error("Error generating video script:", error);
                outputWrapper.classList.remove('hidden');
                outputWrapper.innerHTML = `<div class="p-4 text-center text-red-400"><i data-lucide="alert-triangle" class="w-8 h-8 mx-auto"></i><p class="text-sm mt-2">Lỗi tạo kịch bản</p></div>`;
                safeCreateIcons({nodes: outputWrapper.querySelectorAll('[data-lucide]')}); // Use the safe function
                showModal('custom-modal', 'Đã có lỗi xảy ra khi tạo kịch bản. Vui lòng thử lại.');
            }
        }
       
        async function generateCreativeDesigns() {
            const creativeFile = document.querySelector('#creative-uploader input').files[0];
            if (!creativeFile) {
                showModal('custom-modal', 'Vui lòng tải lên một ảnh để làm nguồn cảm hứng.');
                return;
            }
            
            showResultScreen();
            
            try {
                const resolvedImage = await fileToBase64(creativeFile);
                savedImageParts = [{ inlineData: resolvedImage }];
            } catch (error) {
                showModal('custom-modal', 'Lỗi khi đọc file ảnh.');
                console.error(error);
                return;
            }

            const baseInstruction = `You are an AI Fashion Designer. Your task is to generate a new, original clothing design inspired by the style, color palette, and fabric type from the user's uploaded image. The new design must be suitable for a young Vietnamese professional woman (age 18-34) and reflect a modern, elegant, and versatile style for office, casual outings, and light parties. Present the final design as a high-quality, photorealistic image on a mannequin or as a professional flat lay.`;

            if (creativeInputMode === 'auto') {
                const categories = [
                    { title: 'Đầm Suông Thanh Lịch', task: 'Design a modern, minimalist A-line dress with a high neckline, suitable for the office.' },
                    { title: 'Đầm Xòe Dạo Phố', task: 'Design an elegant, light party dress with a subtle flare and knee-length hem.' },
                    { title: 'Đầm Sơ Mi Công Sở', task: 'Design a versatile shirt dress with a belt, that can be worn for work or casual outings.' },
                    { title: 'Áo Sơ Mi Không Tay', task: 'Design a casual yet stylish sleeveless collared shirt, similar to the style in the reference image.' },
                    { title: 'Áo Blouse Tay Phồng', task: 'Design a classic blouse with a modern twist, like subtle bishop sleeves.' },
                    { title: 'Áo Kiểu Tối Giản', task: 'Design a minimalist, clean-cut top with unique neckline details.' },
                    { title: 'Set: Vest & Chân Váy', task: 'Design a matching set with a sleeveless blazer and a tailored pencil skirt.' },
                    { title: 'Set: Áo & Quần Culottes', task: 'Design a comfortable and chic set with a simple top and wide-leg culottes pants.' },
                    { title: 'Set: Áo & Quần Shorts', task: 'Design a coordinated set with a stylish sleeveless top and tailored city shorts.' },
                    { title: 'Quần Âu Dáng Rộng', task: 'Design a pair of high-waisted, wide-leg trousers (quần âu) in a flowing fabric.' },
                    { title: 'Quần Âu Dáng Đứng', task: 'Design a pair of slim-fit, ankle-length tailored trousers for a professional look.' },
                    { title: 'Chân Váy Bút Chì', task: 'Design a modern pencil skirt with a high waist and a subtle front or side slit.' },
                ];
                finalPrompts = categories.map(cat => `${baseInstruction} SPECIFIC TASK: ${cat.task}`);
                const resultGrid = document.getElementById('result-grid');
                resultGrid.classList.add('md:grid-cols-3', 'lg:grid-cols-4');
                categories.forEach(cat => {
                    const placeholder = document.createElement('div');
                    placeholder.className = `result-image-wrapper flex flex-col items-center justify-center aspect-square`;
                    placeholder.innerHTML = `<div class="loader"></div><p class="mt-4 text-sm text-gray-400">${cat.title}</p>`;
                    resultGrid.appendChild(placeholder);
                });

            } else { // manual mode
                const userPrompt = document.getElementById('creative-prompt').value;
                if (!userPrompt) {
                    showModal('custom-modal', 'Vui lòng mô tả ý tưởng thiết kế của bạn.');
                    backToEdit();
                    return;
                }
                const fullPrompt = `${baseInstruction} SPECIFIC TASK: ${userPrompt}`;
                finalPrompts = Array(4).fill(fullPrompt); // Generate 4 variations of the user's idea
                const resultGrid = document.getElementById('result-grid');
                resultGrid.classList.add('md:grid-cols-3', 'lg:grid-cols-4');
                finalPrompts.forEach((p, i) => {
                    const placeholder = document.createElement('div');
                    placeholder.className = `result-image-wrapper flex flex-col items-center justify-center aspect-square`;
                    placeholder.innerHTML = `<div class="loader"></div><p class="mt-4 text-sm text-gray-400">Đang tạo #${i+1}</p>`;
                    resultGrid.appendChild(placeholder);
                });
            }

            let successfulImages = 0;
            const generationPromises = finalPrompts.map((p, i) => generateSingleImage(i, p, 'creative-design').then(s => { if(s) successfulImages++; }));
            await Promise.all(generationPromises);

            document.getElementById('result-header').textContent = `Hoàn thành! (${successfulImages}/${finalPrompts.length})`;
            document.getElementById('result-subheader').textContent = 'Đây là bộ sưu tập AI đã sáng tạo cho bạn.';
            document.getElementById('restart-btn').classList.remove('hidden');
            document.getElementById('back-to-edit-btn').classList.remove('hidden');
        }
        
        async function generateDesignImages() {
            const designFile = document.querySelector('#design-uploader input').files[0];
            const fabricFile = document.querySelector('#fabric-uploader input').files[0];
            const colorPrompt = document.getElementById('design-color-prompt').value;
            const fabricLocation = document.getElementById('fabric-location-prompt').value;

            if (!designFile) { showModal('custom-modal', 'Vui lòng tải lên ảnh trang phục.'); return; }
            if (designInputMode === 'color' && !colorPrompt) { showModal('custom-modal', 'Vui lòng nhập mô tả màu sắc.'); return; }
            if (designInputMode === 'fabric' && !fabricFile) { showModal('custom-modal', 'Vui lòng tải lên ảnh mẫu vải.'); return; }
            showResultScreen();
            try {
                const imagePromises = [fileToBase64(designFile)];
                if (designInputMode === 'fabric') imagePromises.push(fileToBase64(fabricFile));
                savedImageParts = (await Promise.all(imagePromises)).map(img => ({inlineData: img}));
            } catch (error) { showModal('custom-modal', 'Lỗi khi đọc file ảnh.'); console.error(error); return; }
            let basePrompt;
            if (designInputMode === 'color') {
                basePrompt = `You are an AI photo editor specializing in fashion. Your task is to realistically change the color of the garment in the provided image. \n- The new color should be: **${colorPrompt}**. \n- You must keep everything else in the image exactly the same: the garment's shape, its folds, the lighting, the shadows, and the background. \n- Only change the color of the main clothing item.`;
            } else { 
                const locationInstruction = fabricLocation.trim() ? `\n- Apply this texture ONLY to the following part of the garment: **${fabricLocation.trim()}**.` : '';
                basePrompt = `You are an AI fashion designer. Your task is to apply a new texture to a piece of clothing. \n- The **first image** is the piece of clothing you need to modify. \n- The **second image** is the fabric texture you must apply. \nYour goal is to realistically replace the fabric of the clothing in the first image with the texture from the second image. The final image should show the exact same piece of clothing, but with the new fabric. Preserve the original shape, lighting, and folds of the garment.${locationInstruction}`; 
            }
            finalPrompts = Array(4).fill(basePrompt);
            const resultGrid = document.getElementById('result-grid');
            finalPrompts.forEach((p, i) => {
                const placeholder = document.createElement('div');
                placeholder.className = `result-image-wrapper flex flex-col items-center justify-center aspect-square`;
                placeholder.innerHTML = `<div class="loader"></div><p class="mt-4 text-sm text-gray-400">Đang tạo #${i+1}</p>`;
                resultGrid.appendChild(placeholder);
            });
            let successfulImages = 0;
            const generationPromises = finalPrompts.map((p, i) => generateSingleImage(i, p, 'design').then(s => { if(s) successfulImages++; }));
            await Promise.all(generationPromises);
            document.getElementById('result-header').textContent = `Hoàn thành! (${successfulImages}/${finalPrompts.length})`;
            document.getElementById('result-subheader').textContent = 'Đây là những thiết kế AI đã tạo ra.';
            document.getElementById('restart-btn').classList.remove('hidden');
            document.getElementById('back-to-edit-btn').classList.remove('hidden');
        }

        async function generateSingleImage(index, prompt, tool) {
            const placeholder = document.getElementById('result-grid').children[index];
            placeholder.innerHTML = `<div class="loader"></div><p class="mt-4 text-sm text-gray-400">Đang tạo...</p>`;
            try {
                 const apiKey = "AIzaSyAAgKXiYFW4-ANBJ08W39gj_vHvhBSD6kQ";
                 const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                 const payload = { contents: [{ parts: [{ text: prompt }, ...savedImageParts] }], generationConfig: { responseModalities: ['IMAGE'] } };
                 const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                 if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
                 const result = await response.json();
                 const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                 if (!base64Data) throw new Error("No image data returned.");
                 const imageUrl = `data:image/png;base64,${base64Data}`;
                 const filename = `bm-ai-studio-${tool}-${index+1}.png`;
                 
                 let buttonsHtml = '';
                 if (tool === 'model') {
                     buttonsHtml = `
                        <button onclick="regenerateVariations(${index})" class="bg-black/60 p-2 rounded-full text-white hover:bg-indigo-500" title="Tạo 5 biến thể mới"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
                        <button onclick="openEditModal(${index}, '${tool}', '${imageUrl}')" class="bg-black/60 p-2 rounded-full text-white hover:bg-indigo-500" title="Chỉnh sửa chi tiết"><i data-lucide="edit" class="w-5 h-5"></i></button>
                        <button onclick="saveBackground(${index})" class="bg-black/60 p-2 rounded-full text-white hover:bg-indigo-500" title="Lưu bối cảnh"><i data-lucide="save" class="w-5 h-5"></i></button>
                    `;
                 } else if (tool === 'creative-design' || tool === 'design' || (tool === 'product' && productInputMode === 'text')) {
                     buttonsHtml = `
                        <button onclick="openEditModal(${index}, '${tool}', '${imageUrl}')" class="bg-black/60 p-2 rounded-full text-white hover:bg-indigo-500" title="Chỉnh sửa chi tiết"><i data-lucide="edit" class="w-5 h-5"></i></button>
                     `;
                 }

                 placeholder.innerHTML = `
                    <img src="${imageUrl}" alt="Generated image ${index + 1}" class="w-full h-full object-cover animate-fade-in cursor-pointer" onclick="openImageModal('${imageUrl}')">
                    <div class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/80 to-transparent">
                        <div class="flex justify-center items-center space-x-3">
                            ${buttonsHtml}
                            <a href="${imageUrl}" download="${filename}" class="bg-black/60 p-2 rounded-full text-white hover:bg-indigo-500" title="Tải về">
                                <i data-lucide="download" class="w-5 h-5"></i>
                            </a>
                        </div>
                 `;
                safeCreateIcons({nodes: placeholder.querySelectorAll('[data-lucide]')}); // Use the safe function
                return true;
            } catch (error) {
                console.error(`Failed image gen for index ${index}:`, error);
                placeholder.innerHTML = `<div class="p-4 text-center text-red-400 flex flex-col items-center justify-center h-full"><i data-lucide="alert-triangle" class="w-8 h-8"></i><p class="text-sm mt-2">Lỗi tạo ảnh</p><button onclick="regenerateOneImage(${index}, '${tool}')" class="mt-2 text-xs text-indigo-400 hover:underline">Thử lại</button></div>`;
                safeCreateIcons({nodes: placeholder.querySelectorAll('[data-lucide]')}); // Use the safe function
                return false;
            }
        }

        function regenerateOneImage(index, tool) { 
            generateSingleImage(index, finalPrompts[index], tool); 
        }

        function openEditModal(index, tool, imageUrl) {
            if ((tool === 'product' && productInputMode === 'ref') || (tool === 'design' && designInputMode === 'fabric')) {
                showModal('custom-modal', 'Chức năng chỉnh sửa không áp dụng cho chế độ dùng ảnh tham chiếu hoặc phối cận vải.'); return;
            }
            document.getElementById('edit-modal-img').src = imageUrl;
            document.getElementById('edit-prompt-textarea').value = finalPrompts[index];
            document.getElementById('edit-changes-textarea').value = '';
            document.getElementById('edit-modal-index').value = index;
            document.getElementById('edit-modal-tool').value = tool;
            showModal('edit-modal');
        }

        async function regenerateFromModal() {
            const index = document.getElementById('edit-modal-index').value;
            const tool = document.getElementById('edit-modal-tool').value;
            const basePrompt = document.getElementById('edit-prompt-textarea').value;
            const changes = document.getElementById('edit-changes-textarea').value;
            let newPrompt = basePrompt;
            if (changes.trim()) {
                newPrompt += `\n- ADDITIONAL INSTRUCTIONS FOR REGENERATION: Please apply the following changes: ${changes.trim()}.`;
            }
            finalPrompts[index] = newPrompt;
            closeModal('edit-modal');
            await generateSingleImage(index, newPrompt, tool);
        }

        async function generateImages(mode = false, customPrompt = '', forceReloadImages = false) {
            showResultScreen();
            let accessoryFile; // Define here to check its value later

            if (savedImageParts.length === 0 || forceReloadImages) {
                try {
                    const imageFiles = [];
                    promptImageDescriptions = []; // Reset descriptions

                    const modelFile = document.querySelector('#model-uploader input').files[0];
                    const outfitFile = document.querySelector('#outfit-uploader input').files[0];
                    accessoryFile = document.querySelector('#accessory-uploader input').files[0];
                    
                    if (!modelFile || !outfitFile) {
                         showModal('custom-modal', 'Lỗi: Không tìm thấy ảnh người mẫu hoặc trang phục.');
                         backToEdit();
                         return;
                    }

                    imageFiles.push(modelFile);
                    promptImageDescriptions.push("The 1st image is the main model.");
                    
                    imageFiles.push(outfitFile);
                    promptImageDescriptions.push("The 2nd image is the outfit.");
                    
                    if (accessoryFile) {
                        imageFiles.push(accessoryFile);
                        promptImageDescriptions.push("The 3rd image is an accessory.");
                    }

                    const companionMaleFile = document.querySelector('#companion-male-uploader input').files[0];
                    if (companionMaleFile) {
                        imageFiles.push(companionMaleFile);
                        promptImageDescriptions.push(`The ${imageFiles.length}th image is a reference for the male companion's face/appearance.`);
                    }
                    
                    const companionFemaleFile = document.querySelector('#companion-female-uploader input').files[0];
                    if (companionFemaleFile) {
                        imageFiles.push(companionFemaleFile);
                        promptImageDescriptions.push(`The ${imageFiles.length}th image is a reference for the female companion's face/appearance.`);
                    }

                    const companionFemaleOutfitFile = document.querySelector('#companion-female-outfit-uploader input').files[0];
                     if (companionFemaleOutfitFile) {
                        imageFiles.push(companionFemaleOutfitFile);
                        promptImageDescriptions.push(`The ${imageFiles.length}th image is the outfit for the female companion.`);
                    }

                    const companionBabyFile = document.querySelector('#companion-baby-uploader input').files[0];
                    if (companionBabyFile) {
                        imageFiles.push(companionBabyFile);
                        promptImageDescriptions.push(`The ${imageFiles.length}th image is a reference for the baby's face/appearance.`);
                    }
                    
                    const imagePromises = imageFiles.map(file => fileToBase64(file));
                    const resolvedImages = await Promise.all(imagePromises);
                    savedImageParts = resolvedImages.map(img => ({ inlineData: img }));

                } catch (error) {
                    showModal('custom-modal', 'Lỗi khi đọc file ảnh. Vui lòng thử lại.');
                    console.error(error);
                    backToEdit();
                    return;
                }
            }

            const gender = document.querySelector('input[name="gender"]:checked')?.value || 'female';
            let baseInstruction = `INSTRUCTION: Create a photorealistic fashion image based on the following uploaded images and descriptions.\n` + promptImageDescriptions.join('\n') + `\n\n- IMPORTANT: The main model's face MUST be preserved from the first image.\n- IMPORTANT: Dress the main model in the clothes from the second image.\n` + (accessoryFile ? '- IMPORTANT: Include the accessory from the third image.\n' : '') + `- The main model is a beautiful Vietnamese ${gender === 'male' ? 'man' : 'woman'}.`;
            
            const getSelectedValue = (group) => document.querySelector(`[data-group="${group}"] .selected`)?.dataset.value || null;
            const finalAspectRatio = getSelectedValue('final-aspect-ratio') || 'default (3:4 portrait)';

            let userPrompt;
            if (mode === true) {
                userPrompt = "\n- AI ASSISTANT: You have creative freedom. Choose the best combination of pose, hair, background, and lighting to create a stunning, professional, and artistic photograph.";
            } else if (mode === 'custom' && customPrompt) {
                userPrompt = `\n- ${customPrompt}`;
            } else {
                
                const companions = [];
                const maleHair = document.getElementById('companion-male-hair').value.trim();
                const maleAge = document.getElementById('companion-male-age').value.trim();
                let maleOutfit = document.querySelector('[data-group="male-outfit"] .selected')?.textContent || '';
                const maleOutfitCustom = document.getElementById('companion-male-outfit-custom').value.trim();
                if (maleOutfitCustom) maleOutfit = maleOutfitCustom;
                if (maleHair || maleAge || maleOutfit || document.querySelector('#companion-male-uploader input').files.length > 0) {
                    let maleDesc = "a male companion";
                    if (maleAge) maleDesc += ` around ${maleAge}`;
                    if (maleHair) maleDesc += ` with ${maleHair} hair`;
                    if (maleOutfit) maleDesc += ` wearing a ${maleOutfit}`;
                    companions.push(maleDesc);
                }

                const femaleHair = document.getElementById('companion-female-hair').value.trim();
                const femaleAge = document.getElementById('companion-female-age').value.trim();
                const femaleOutfitFile = document.querySelector('#companion-female-outfit-uploader input').files[0];
                if (femaleHair || femaleAge || document.querySelector('#companion-female-uploader input').files.length > 0 || femaleOutfitFile) {
                    let femaleDesc = "a female companion";
                    if (femaleAge) femaleDesc += ` around ${femaleAge}`;
                    if (femaleHair) femaleDesc += ` with ${femaleHair} hair`;
                    if (femaleOutfitFile) {
                        femaleDesc += `, wearing the outfit specified in its corresponding reference image`;
                    } else {
                        femaleDesc += `, wearing an outfit that matches the main model's`;
                    }
                    companions.push(femaleDesc);
                }

                const babyHair = document.getElementById('companion-baby-hair').value.trim();
                const babyAge = document.getElementById('companion-baby-age').value.trim();
                const babyAccessories = document.getElementById('companion-baby-accessories').value.trim();
                if (document.querySelector('#companion-baby-uploader input').files.length > 0 || babyHair || babyAge || babyAccessories) {
                    let babyDesc = "a baby";
                    if (babyAge) babyDesc += ` around ${babyAge}`;
                    if (babyHair) babyDesc += ` with ${babyHair} hair`;
                    if (babyAccessories) babyDesc += ` with these accessories: ${babyAccessories}`;
                    babyDesc += ", wearing an outfit that matches the main model's";
                    companions.push(babyDesc);
                }

                const pet = document.getElementById('companion-pet').value.trim();
                if (pet) companions.push(`a pet ${pet}`);
                
                const mythical = document.getElementById('companion-mythical').value.trim();
                if (mythical) {
                    let mythicalDesc = `a hyperrealistic, ultra-detailed, photorealistic mythical ${mythical} with cinematic lighting`;
                    if (document.getElementById('companion-mythical-giant').checked) {
                        mythicalDesc = `a giant, towering, hyperrealistic, ultra-detailed, photorealistic mythical ${mythical} with cinematic lighting, much larger than the model`;
                    }
                    companions.push(mythicalDesc);
                }

                const companionsPrompt = companions.length > 0 ? `\n- Other people/creatures in the photo: ${companions.join('; ')}.` : '';

                userPrompt = `\n- Pose: ${getSelectedValue('pose') || 'a natural candid pose'}.\n- Hair: ${getSelectedValue('hair-style') || 'long wavy hair'}.\n- Outfit Style: ${getSelectedValue('dress-length') || 'a stylish outfit'}.\n- Location: ${getSelectedValue('background') || 'a beautiful place'}.\n- Image Style: ${getSelectedValue('color-tone') || 'a cinematic style'}.\n- Quality: ${getSelectedValue('quality') || '4K, high quality'}.${companionsPrompt}`;
            }

            userPrompt += `\n- Aspect Ratio: ${finalAspectRatio}.`;
            if (finalAspectRatio.includes('9:16')) {
                 userPrompt += `\n- FINAL AND MOST IMPORTANT INSTRUCTION: The final image's aspect ratio ABSOLUTELY MUST BE a vertical 9:16 portrait. Do not generate a 1:1 square image under any circumstances. The output must be tall and vertical (9:16), like a phone screen.`;
            }

            currentBasePrompt = baseInstruction + userPrompt;
            
            const angles = [
                { title: 'Toàn Thân', modifier: 'The photo composition should be a full body shot...' },
                { title: 'Trung Cảnh', modifier: 'The photo composition should be a medium shot...' },
                { title: 'Chân Dung', modifier: 'The photo composition should be a close-up portrait...' },
                { title: 'Tự Nhiên', modifier: 'The photo composition should be a candid action shot...' },
                { title: 'Chi Tiết', modifier: 'The photo composition should be a detailed close-up shot...' }
            ];

            const resultGrid = document.getElementById('result-grid');
            finalPrompts = [];
            angles.forEach(angle => {
                finalPrompts.push(`${currentBasePrompt}\n- ${angle.modifier}`);
                const placeholder = document.createElement('div');
                placeholder.className = 'result-image-wrapper flex flex-col items-center justify-center aspect-[2/3]';
                placeholder.innerHTML = `<div class="loader"></div><p class="mt-4 text-sm text-gray-400">${angle.title}</p>`;
                resultGrid.appendChild(placeholder);
            });

            let successfulImages = 0;
            const generationPromises = finalPrompts.map((p, i) => generateSingleImage(i, p, 'model').then(s => { if (s) successfulImages++; }));
            await Promise.all(generationPromises);

            document.getElementById('result-header').textContent = `Hoàn thành! (${successfulImages}/${angles.length})`;
            document.getElementById('result-subheader').textContent = 'Đây là những hình ảnh AI đã tạo ra cho bạn.';
            document.getElementById('restart-btn').classList.remove('hidden');
            document.getElementById('back-to-edit-btn').classList.remove('hidden');
        }

        async function generateProductImages() {
            const productFile = document.querySelector('#product-uploader input').files[0];
            const refFile = document.querySelector('#ref-uploader input').files[0];
            const promptText = document.getElementById('product-prompt').value;
            if (!productFile) {
                showModal('custom-modal', 'Vui lòng tải lên ảnh sản phẩm.');
                return;
            }
            if (productInputMode === 'text' && !promptText) {
                showModal('custom-modal', 'Vui lòng nhập mô tả cho bối cảnh.');
                return;
            }
            if (productInputMode === 'ref' && !refFile) {
                showModal('custom-modal', 'Vui lòng tải lên ảnh tham chiếu.');
                return;
            }
            showResultScreen();
            try {
                const imagePromises = [fileToBase64(productFile)];
                if (productInputMode === 'ref') {
                    imagePromises.push(fileToBase64(refFile));
                }
                const resolvedImages = await Promise.all(imagePromises);
                savedImageParts = resolvedImages.map(img => ({
                    inlineData: img
                }));
            } catch (error) {
                showModal('custom-modal', 'Lỗi khi đọc file ảnh.');
                console.error(error);
                return;
            }
            const aspectRatioEl = document.querySelector('[data-group="product-aspect-ratio"] .selected');
            const aspectRatioValue = aspectRatioEl?.dataset.value || '1:1 (Square)';
            const aspectRatioClass = aspectRatioEl?.dataset.class || 'aspect-square';
            let basePrompt;
            if (productInputMode === 'text') {
                basePrompt = `INSTRUCTION: Create a professional product photograph. Use the product from the uploaded image. Place it in the following scene. The image must NOT contain any people or models. Focus on high-quality lighting, shadows, and composition to make it look realistic.\n- Aspect Ratio: ${aspectRatioValue}\n- SCENE: ${promptText}`;
            } else {
                basePrompt = `INSTRUCTION: Create a professional product photograph. Use the product from the first uploaded image. Place it in a scene that perfectly matches the style, mood, lighting, and environment of the second uploaded image. The final image must NOT contain any people or models from the reference image, only the product from the first image. Make it look hyperrealistic.\n- Aspect Ratio: ${aspectRatioValue}`;
            }
            finalPrompts = [basePrompt, basePrompt, basePrompt, basePrompt];
            const resultGrid = document.getElementById('result-grid');
            finalPrompts.forEach((p, i) => {
                const placeholder = document.createElement('div');
                placeholder.className = `result-image-wrapper flex flex-col items-center justify-center ${aspectRatioClass}`;
                placeholder.innerHTML = `<div class="loader"></div><p class="mt-4 text-sm text-gray-400">Đang tạo #${i + 1}</p>`;
                resultGrid.appendChild(placeholder);
            });
            let successfulImages = 0;
            const generationPromises = finalPrompts.map((p, i) => generateSingleImage(i, p, 'product').then(s => {
                if (s) successfulImages++;
            }));
            await Promise.all(generationPromises);
            document.getElementById('result-header').textContent = `Hoàn thành! (${successfulImages}/${finalPrompts.length})`;
            document.getElementById('result-subheader').textContent = 'Đây là những ảnh sản phẩm AI đã tạo ra.';
            document.getElementById('restart-btn').classList.remove('hidden');
            document.getElementById('back-to-edit-btn').classList.remove('hidden');
        }

        // --- Functions for Face Swap Tool (Global Scope) ---
        function openFaceSwapEditModal(index, imageUrl) {
            document.getElementById('refine-index-faceswap').value = index;
            document.getElementById('refine-prompt-faceswap').value = ''; // Clear old text
            showModal('refine-modal-faceswap');
        }

        async function scopedFileToBase64_Global(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }
        
        async function callFaceSwapImageApi_Global(payload) {
             const apiKey = "AIzaSyAAgKXiYFW4-ANBJ08W39gj_vHvhBSD6kQ";
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
             let response;
             let retries = 3;
             let delay = 1000;
             for (let i = 0; i < retries; i++) {
                 response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                 if (response.ok) break;
                 if (response.status === 429 || response.status >= 500) {
                     if (i < retries - 1) {
                         await new Promise(resolve => setTimeout(resolve, delay));
                         delay *= 2;
                     } else { throw new Error(`Lỗi API sau ${retries} lần thử: ${response.statusText}`); }
                 } else { throw new Error(`Lỗi từ máy chủ: ${response.statusText}`); }
             }
             const result = await response.json();
             const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
             if (base64Data) { return base64Data; } 
             else { throw new Error("Không nhận được dữ liệu hình ảnh hợp lệ từ AI. Vui lòng thử lại."); }
        }

        async function regenerateFaceSwapFromModal() {
            const btn = document.getElementById('submit-refine-btn-faceswap');
            const btnText = document.getElementById('submit-refine-text-faceswap');
            const loader = document.getElementById('submit-refine-loader-faceswap');
            
            btn.disabled = true;
            btnText.classList.add('hidden');
            loader.classList.remove('hidden');

            try {
                const index = document.getElementById('refine-index-faceswap').value;
                const refinementText = document.getElementById('refine-prompt-faceswap').value.trim();
                if (!refinementText) {
                    showModal('custom-modal', 'Vui lòng nhập yêu cầu chỉnh sửa.');
                    return; 
                }

                const sceneDescription = faceSwap_Prompts[index];
                const placeholder = document.getElementById('result-grid').children[index];
                placeholder.innerHTML = `<div class="loader"></div><p class="mt-4 text-sm text-gray-400">Đang tinh chỉnh...</p>`;
                
                let hairInstruction = '';
                let instructionNumber = 3;
                const payloadParts = [ 
                    { text: '' }, 
                    { inlineData: { mimeType: faceSwap_FaceFile.type, data: faceSwap_FaceBase64 } }, 
                    { inlineData: { mimeType: faceSwap_OutfitFile.type, data: faceSwap_OutfitBase64 } } 
                ];

                if (faceSwap_HairBase64) {
                    payloadParts.push({ inlineData: { mimeType: faceSwap_HairFile.type, data: faceSwap_HairBase64 } });
                    hairInstruction = `\n${instructionNumber}. **Kiểu tóc:** Phải sử dụng kiểu tóc từ ảnh thứ ba.`;
                    instructionNumber++;
                } else if (faceSwap_HairDescription) {
                    hairInstruction = `\n${instructionNumber}. **Kiểu tóc:** Phải tạo kiểu tóc theo mô tả sau: "${faceSwap_HairDescription}".`;
                    instructionNumber++;
                }
                
                const finalPrompt = `**YÊU CẦU BẮT BUỘC (TINH CHỈNH):** Tạo ảnh một người. **KHÔNG ĐƯỢC PHÉP SAI LỆCH.**
1. **Gương mặt:** Phải sử dụng gương mặt từ ảnh đầu tiên.
2. **Trang phục:** Phải sử dụng toàn bộ trang phục từ ảnh thứ hai.${hairInstruction}
${instructionNumber}. **Bối cảnh:** Đặt người mẫu vào bối cảnh được mô tả sau: ${sceneDescription}.
${instructionNumber + 1}. **Yêu cầu tinh chỉnh:** ${refinementText}

**LƯU Ý:** Việc tuân thủ chính xác các yêu cầu là quan trọng nhất, đặc biệt là yêu cầu tinh chỉnh.`;

                payloadParts[0].text = finalPrompt;
                const payload = { contents: [{ parts: payloadParts }], generationConfig: { responseModalities: ['IMAGE'] } };
                
                const generatedBase64 = await callFaceSwapImageApi_Global(payload);
                const imageUrl = `data:image/png;base64,${generatedBase64}`;
                const filename = `bm-ai-studio-faceswap-${index+1}-refined.png`;
                
                placeholder.innerHTML = `
                    <img src="${imageUrl}" alt="Generated image ${index + 1}" class="w-full h-full object-cover animate-fade-in cursor-pointer" onclick="openImageModal('${imageUrl}')">
                    <div class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/80 to-transparent">
                        <div class="flex justify-center items-center space-x-3">
                             <button onclick="openFaceSwapEditModal(${index}, '${imageUrl}')" class="bg-black/60 p-2 rounded-full text-white hover:bg-indigo-500" title="Chỉnh sửa chi tiết"><i data-lucide="edit" class="w-5 h-5"></i></button>
                             <a href="${imageUrl}" download="${filename}" class="bg-black/60 p-2 rounded-full text-white hover:bg-indigo-500" title="Tải về">
                                <i data-lucide="download" class="w-5 h-5"></i>
                            </a>
                        </div>
                </div>`;
                safeCreateIcons({nodes: placeholder.querySelectorAll('[data-lucide]')}); // Use the safe function
                closeModal('refine-modal-faceswap');

            } catch (error) {
                console.error("Error refining face swap image:", error);
                showModal('custom-modal', `Lỗi khi tinh chỉnh ảnh: ${error.message}`);
                const index = document.getElementById('refine-index-faceswap').value;
                const placeholder = document.getElementById('result-grid').children[index];
                if (placeholder) {
                    placeholder.innerHTML = `<div class="p-4 text-center text-red-400 flex flex-col items-center justify-center h-full"><i data-lucide="alert-triangle" class="w-8 h-8"></i><p class="text-sm mt-2">Lỗi tinh chỉnh</p></div>`;
                    safeCreateIcons({nodes: placeholder.querySelectorAll('[data-lucide]')}); // Use the safe function
                }
            } finally {
                btn.disabled = false;
                btnText.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }


        // --- NEW TOOL: Face Swap Logic ---
        function initializeFaceSwapTool() {
            // DOM Elements for multi-upload
            const styleMultiUploader = document.getElementById('style-multi-uploader-faceswap');
            const styleMultiUploadInput = document.getElementById('style-upload-faceswap-multi');
            const stylePreviewsContainer = document.getElementById('style-previews-container-faceswap');
            const generatePromptsBtn = document.getElementById('generate-prompts-btn');
            const generatePromptsText = document.getElementById('generate-prompts-text');
            const generatePromptsLoader = document.getElementById('generate-prompts-loader');
            const generatedPromptsLog = document.getElementById('generated-prompts-log');

            const faceUploadBox = document.getElementById('face-upload-box');
            const faceUploadInput = document.getElementById('face-upload');
            const facePreview = document.getElementById('face-preview');

            const outfitUploadBox = document.getElementById('outfit-upload-box-faceswap');
            const outfitUploadInput = document.getElementById('outfit-upload-faceswap');
            const outfitPreview = document.getElementById('outfit-preview-faceswap');

            const hairUploadBox = document.getElementById('hair-upload-box');
            const hairUploadInput = document.getElementById('hair-upload');
            const hairPreview = document.getElementById('hair-preview');
            const hairDescriptionInput = document.getElementById('hair-description-input'); 

            const promptInput = document.getElementById('prompt');
            const generateBtn = document.getElementById('generate-btn-faceswap');

            // Hide the old single-result container for this tool
            const oldResultContainer = document.querySelector('#face-swap-tool-container .lg\\:flex');
            if(oldResultContainer) oldResultContainer.classList.add('hidden');

            // File storage
            let styleFiles = [];
            let generatedStylePrompts = [];

            // --- Utility Functions (scoped to this tool) ---
            function scopedFileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = error => reject(error);
                });
            }

            async function callFaceSwapImageApi(payload) {
                 const apiKey = "AIzaSyAAgKXiYFW4-ANBJ08W39gj_vHvhBSD6kQ";
                 const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                 let response;
                 let retries = 3;
                 let delay = 1000;
                 for (let i = 0; i < retries; i++) {
                     response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                     if (response.ok) break;
                     if (response.status === 429 || response.status >= 500) {
                         if (i < retries - 1) {
                             await new Promise(resolve => setTimeout(resolve, delay));
                             delay *= 2;
                         } else { throw new Error(`Lỗi API sau ${retries} lần thử: ${response.statusText}`); }
                     } else { throw new Error(`Lỗi từ máy chủ: ${response.statusText}`); }
                 }
                 const result = await response.json();
                 const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                 if (base64Data) { return base64Data; } 
                 else { throw new Error("Không nhận được dữ liệu hình ảnh hợp lệ từ AI. Vui lòng thử lại."); }
            }
            
            // --- Event Handlers ---
            function handleImageUpload(input, preview, box, fileStore) {
                const file = input.files[0];
                if (file) {
                    fileStore.file = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                        box.querySelector('.placeholder').classList.add('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            }

            function handleMultipleImageUpload(input, container) {
                const files = input.files;
                container.innerHTML = '';
                styleFiles = [];

                if (files && files.length > 0) {
                    let filesToProcess = Array.from(files);
                    if (files.length > 6) {
                        showModal('custom-modal', 'Bạn chỉ có thể tải lên tối đa 6 ảnh.');
                        filesToProcess = filesToProcess.slice(0, 6);
                    }
                    styleFiles = filesToProcess;

                    styleFiles.forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const imgWrapper = document.createElement('div');
                            imgWrapper.className = 'relative aspect-square rounded-md overflow-hidden animate-fade-in';
                            imgWrapper.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                            container.appendChild(imgWrapper);
                        };
                        reader.readAsDataURL(file);
                    });
                }
            }
            
            faceUploadBox.addEventListener('click', () => faceUploadInput.click());
            faceUploadInput.addEventListener('change', () => handleImageUpload(faceUploadInput, facePreview, faceUploadBox, { set file(f) { faceSwap_FaceFile = f; } }));
            outfitUploadBox.addEventListener('click', () => outfitUploadInput.click());
            outfitUploadInput.addEventListener('change', () => handleImageUpload(outfitUploadInput, outfitPreview, outfitUploadBox, { set file(f) { faceSwap_OutfitFile = f; } }));
            
            hairUploadBox.addEventListener('click', () => hairUploadInput.click());
            hairUploadInput.addEventListener('change', () => {
                handleImageUpload(hairUploadInput, hairPreview, hairUploadBox, { set file(f) { faceSwap_HairFile = f; } });
                if (hairDescriptionInput) hairDescriptionInput.value = ''; // Clear description if user uploads an image
            });
            if (hairDescriptionInput) {
                hairDescriptionInput.addEventListener('input', () => { // Logic to clear image if text is typed
                    if(faceSwap_HairFile) {
                        hairUploadInput.value = '';
                        hairPreview.src = '';
                        hairPreview.classList.add('hidden');
                        hairUploadBox.querySelector('.placeholder').classList.remove('hidden');
                        faceSwap_HairFile = null;
                    }
                });
            }

            styleMultiUploadInput.addEventListener('change', () => handleMultipleImageUpload(styleMultiUploadInput, stylePreviewsContainer));

            generatePromptsBtn.addEventListener('click', async () => {
                if (!styleFiles || styleFiles.length === 0) {
                    showModal('custom-modal', 'Vui lòng tải lên ít nhất một ảnh mẫu để tạo mô tả.');
                    return;
                }
                
                generatedStylePrompts = [];
                generatedPromptsLog.innerHTML = '';
                generatedPromptsLog.classList.add('hidden');
                generatePromptsBtn.disabled = true;
                generatePromptsText.classList.add('hidden');
                generatePromptsLoader.classList.remove('hidden');

                try {
                    const promptForDesc = "Bạn là một chuyên gia nhiếp ảnh và thời trang. Hãy mô tả chi tiết bức ảnh này để sử dụng làm prompt cho AI tạo ảnh. Tập trung vào góc chụp (ví dụ: góc cao, góc thấp), ánh sáng (ví dụ: giờ vàng, studio), bối cảnh, phong cách, màu sắc chủ đạo và cảm xúc. Chỉ trả về phần mô tả cảnh vật, không thêm bất kỳ hướng dẫn nào khác.";
                    
                    const promptGenerationPromises = styleFiles.map(async (file) => {
                        const styleBase64 = await scopedFileToBase64(file);
                        const apiKey = "AIzaSyAAgKXiYFW4-ANBJ08W39gj_vHvhBSD6kQ";
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                        const payload = { contents: [{ parts: [{ text: promptForDesc }, { inlineData: { mimeType: file.type, data: styleBase64 } }] }] };
                        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!response.ok) throw new Error(`Lỗi API: ${response.statusText}`);
                        const result = await response.json();
                        return result.candidates?.[0]?.content?.parts?.[0]?.text;
                    });

                    const results = await Promise.all(promptGenerationPromises);
                    
                    generatedPromptsLog.innerHTML = '<h4>Các mô tả đã được tạo:</h4><ul class="list-disc list-inside mt-2 space-y-1"></ul>';
                    const ul = generatedPromptsLog.querySelector('ul');
                    results.forEach((text, index) => {
                        if (text) {
                            generatedStylePrompts.push(text);
                            const li = document.createElement('li');
                            li.textContent = `Ảnh ${index+1}: ${text.substring(0, 80)}...`;
                            ul.appendChild(li);
                        }
                    });

                    if (generatedStylePrompts.length > 0) {
                        generatedPromptsLog.classList.remove('hidden');
                        promptInput.value = '';
                        promptInput.placeholder = `${generatedStylePrompts.length} mô tả đã được tạo. Bạn có thể tạo ảnh ngay bây giờ.`;
                    } else {
                         throw new Error("AI không thể tạo mô tả từ bất kỳ ảnh nào. Vui lòng thử lại với ảnh khác.");
                    }
                } catch (error) {
                    console.error('Lỗi khi tạo mô tả:', error);
                    showModal('custom-modal', `Lỗi tạo mô tả: ${error.message}`);
                } finally {
                    generatePromptsBtn.disabled = false;
                    generatePromptsText.classList.remove('hidden');
                    generatePromptsLoader.classList.add('hidden');
                }
            });

            generateBtn.addEventListener('click', async () => {
                if (!faceSwap_FaceFile || !faceSwap_OutfitFile) {
                    showModal('custom-modal', 'Vui lòng tải lên cả ảnh gương mặt và trang phục.');
                    return;
                }

                const manualPrompt = promptInput.value.trim();
                let promptsToGenerate = [];

                if (generatedStylePrompts.length > 0) {
                    promptsToGenerate = generatedStylePrompts;
                } else if (manualPrompt) {
                    promptsToGenerate.push(manualPrompt);
                } else {
                    showModal('custom-modal', 'Vui lòng tạo mô tả từ ảnh mẫu (Bước 1) hoặc tự nhập mô tả (Bước 4).');
                    return;
                }
                
                showResultScreen();
                const resultGrid = document.getElementById('result-grid');
                resultGrid.innerHTML = '';
                promptsToGenerate.forEach((_, i) => {
                    const placeholder = document.createElement('div');
                    placeholder.className = `result-image-wrapper flex flex-col items-center justify-center aspect-[2/3]`;
                    placeholder.innerHTML = `<div class="loader"></div><p class="mt-4 text-sm text-gray-400">Đang tạo ảnh #${i+1}</p>`;
                    resultGrid.appendChild(placeholder);
                });

                faceSwap_Prompts = promptsToGenerate;

                faceSwap_FaceBase64 = await scopedFileToBase64_Global(faceSwap_FaceFile);
                faceSwap_OutfitBase64 = await scopedFileToBase64_Global(faceSwap_OutfitFile);
                faceSwap_HairBase64 = null;
                if (faceSwap_HairFile) { faceSwap_HairBase64 = await scopedFileToBase64_Global(faceSwap_HairFile); }
                faceSwap_HairDescription = hairDescriptionInput.value.trim();

                let successfulImages = 0;
                const generationPromises = promptsToGenerate.map(async (sceneDescription, index) => {
                    const placeholder = resultGrid.children[index];
                    try {
                        let finalPrompt;
                        const payloadParts = [ 
                            { text: '' }, 
                            { inlineData: { mimeType: faceSwap_FaceFile.type, data: faceSwap_FaceBase64 } }, 
                            { inlineData: { mimeType: faceSwap_OutfitFile.type, data: faceSwap_OutfitBase64 } } 
                        ];

                        let hairInstruction = '';
                        let instructionNumber = 3;

                        if (faceSwap_HairBase64) {
                            payloadParts.push({ inlineData: { mimeType: faceSwap_HairFile.type, data: faceSwap_HairBase64 } });
                            hairInstruction = `\n${instructionNumber}. **Kiểu tóc:** Phải sử dụng kiểu tóc từ ảnh thứ ba.`;
                            instructionNumber++;
                        } else if (faceSwap_HairDescription) {
                            hairInstruction = `\n${instructionNumber}. **Kiểu tóc:** Phải tạo kiểu tóc theo mô tả sau: "${faceSwap_HairDescription}".`;
                            instructionNumber++;
                        }
                        
                        finalPrompt = `**YÊU CẦU BẮT BUỘC:** Tạo ảnh một người. **KHÔNG ĐƯỢC PHÉP SAI LỆCH.**
1. **Gương mặt:** Phải sử dụng gương mặt từ ảnh đầu tiên.
2. **Trang phục:** Phải sử dụng toàn bộ trang phục từ ảnh thứ hai.${hairInstruction}
${instructionNumber}. **Bối cảnh:** Đặt người mẫu vào bối cảnh được mô tả sau: ${sceneDescription}.

**LƯU Ý:** Việc tuân thủ chính xác các yêu cầu là quan trọng nhất.`;
                        
                        payloadParts[0].text = finalPrompt;
                        const payload = { contents: [{ parts: payloadParts }], generationConfig: { responseModalities: ['IMAGE'] } };
                        const generatedBase64 = await callFaceSwapImageApi_Global(payload);
                        const imageUrl = `data:image/png;base64,${generatedBase64}`;
                        const filename = `bm-ai-studio-faceswap-${index+1}.png`;
                        placeholder.innerHTML = `
                            <img src="${imageUrl}" alt="Generated image ${index + 1}" class="w-full h-full object-cover animate-fade-in cursor-pointer" onclick="openImageModal('${imageUrl}')">
                            <div class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/80 to-transparent">
                                <div class="flex justify-center items-center space-x-3">
                                     <button onclick="openFaceSwapEditModal(${index}, '${imageUrl}')" class="bg-black/60 p-2 rounded-full text-white hover:bg-indigo-500" title="Chỉnh sửa chi tiết"><i data-lucide="edit" class="w-5 h-5"></i></button>
                                     <a href="${imageUrl}" download="${filename}" class="bg-black/60 p-2 rounded-full text-white hover:bg-indigo-500" title="Tải về">
                                        <i data-lucide="download" class="w-5 h-5"></i>
                                     </a>
                                </div>
                            </div>`;
                        safeCreateIcons({nodes: placeholder.querySelectorAll('[data-lucide]')}); // Use the safe function
                        successfulImages++;
                    } catch (error) {
                        console.error(`Failed image gen for index ${index}:`, error);
                        placeholder.innerHTML = `<div class="p-4 text-center text-red-400 flex flex-col items-center justify-center h-full"><i data-lucide="alert-triangle" class="w-8 h-8"></i><p class="text-sm mt-2">Lỗi tạo ảnh</p></div>`;
                        safeCreateIcons({nodes: placeholder.querySelectorAll('[data-lucide]')}); // Use the safe function
                    }
                });

                await Promise.all(generationPromises);
                document.getElementById('result-header').textContent = `Hoàn thành! (${successfulImages}/${promptsToGenerate.length})`;
                document.getElementById('result-subheader').textContent = 'Đây là những hình ảnh AI đã tạo ra cho bạn.';
                document.getElementById('back-to-edit-btn').classList.remove('hidden');
                document.getElementById('restart-btn').classList.add('hidden');
            });
            safeCreateIcons(); // Use the safe function
        }

        // --- NEW TOOL: Aspect Ratio Logic ---
        async function processAspectRatioChange() {
            const files = document.querySelector('#aspect-ratio-uploader input').files;
            if (files.length === 0) {
                showModal('custom-modal', 'Vui lòng tải lên ít nhất một ảnh.');
                return;
            }

            const selectedRatioEl = document.querySelector('[data-group="aspect-ratio-select"] .selected');
            const ratioValue = selectedRatioEl.dataset.value;
            const targetRatio = eval(ratioValue); // e.g., '4/3' becomes 1.333

            const resultsContainer = document.getElementById('aspect-ratio-results-container');
            resultsContainer.innerHTML = `<div class="flex items-center justify-center h-full"><div class="loader"></div><p class="ml-4">Đang xử lý ${files.length} ảnh...</p></div>`;

            const resultsGrid = document.createElement('div');
            resultsGrid.className = 'grid grid-cols-2 sm:grid-cols-3 gap-4';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                try {
                    const croppedDataUrl = await cropImage(file, targetRatio);

                    const resultWrapper = document.createElement('div');
                    resultWrapper.className = 'relative group animate-fade-in';
                    
                    const img = document.createElement('img');
                    img.src = croppedDataUrl;
                    img.className = 'w-full h-auto object-cover rounded-md';
                    
                    const downloadLink = document.createElement('a');
                    downloadLink.href = croppedDataUrl;
                    const originalName = file.name.substring(0, file.name.lastIndexOf('.'));
                    downloadLink.download = `${originalName}_cropped.png`;
                    downloadLink.className = 'absolute bottom-2 right-2 bg-black/60 p-2 rounded-full text-white opacity-0 group-hover:opacity-100 transition-opacity';
                    downloadLink.innerHTML = `<i data-lucide="download" class="w-5 h-5"></i>`;

                    resultWrapper.appendChild(img);
                    resultWrapper.appendChild(downloadLink);
                    resultsGrid.appendChild(resultWrapper);

                } catch (error) {
                    console.error('Lỗi khi cắt ảnh:', file.name, error);
                    // Optionally, show an error for this specific image in the grid
                }
            }
            
            resultsContainer.innerHTML = '';
            resultsContainer.appendChild(resultsGrid);
            safeCreateIcons(); // Use the safe function
        }

        function cropImage(file, targetRatio) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        let srcX = 0, srcY = 0;
                        let srcWidth = img.width;
                        let srcHeight = img.height;

                        const originalRatio = img.width / img.height;

                        if (originalRatio > targetRatio) {
                            // Original is wider than target
                            srcWidth = img.height * targetRatio;
                            srcX = (img.width - srcWidth) / 2;
                        } else if (originalRatio < targetRatio) {
                            // Original is taller than target
                            srcHeight = img.width / targetRatio;
                            srcY = (img.height - srcHeight) / 2;
                        }
                        
                        // Set canvas size to the cropped portion
                        canvas.width = srcWidth;
                        canvas.height = srcHeight;
                        
                        // Draw the cropped portion to the canvas
                        ctx.drawImage(img, srcX, srcY, srcWidth, srcHeight, 0, 0, srcWidth, srcHeight);
                        
                        // Get data URL
                        resolve(canvas.toDataURL('image/png'));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        // --- NEW TOOL: Vietnam Photoshoot ---
        function initializeVietnamPhotoshootTool() {
            if (isVnToolInitialized) return;

            // --- UI Elements ---
            const generateSingleBtn = document.getElementById('vn-generate-single-btn');
            const generateMultipleBtn = document.getElementById('vn-generate-multiple-btn');
            const resultSection = document.getElementById('vn-result-section');
            const loaderContainer = document.getElementById('vn-loader-container');
            const singleImageResult = document.getElementById('vn-single-image-result');
            const singleImageContainer = document.getElementById('vn-single-image-container');
            const resultImage = document.getElementById('vn-result-image');
            const downloadBtn = document.getElementById('vn-download-btn');
            const editBtn = document.getElementById('vn-edit-btn');
            const errorMessage = document.getElementById('vn-error-message');
            const alertModal = document.getElementById('vn-alert-modal');
            const alertMessage = document.getElementById('vn-alert-message');
            const editModal = document.getElementById('vn-edit-modal');
            const editPromptInput = document.getElementById('vn-edit-prompt-input');
            const confirmEditBtn = document.getElementById('vn-confirm-edit-btn');
            const locationInput = document.getElementById('vn-location-input');
            const suggestionsContainer = document.getElementById('vn-suggestions-container');
            const galleryResults = document.getElementById('vn-gallery-results');
            const galleryActions = document.getElementById('vn-gallery-actions');
            const downloadSelectedBtn = document.getElementById('vn-download-selected-btn');
            const editSelectedBtn = document.getElementById('vn-edit-selected-btn');
            const imageViewerModal = document.getElementById('vn-image-viewer-modal');
            const enlargedImage = document.getElementById('vn-enlarged-image');
            const saveLocationBtn = document.getElementById('vn-save-location-btn');
            
            // Upload buttons and inputs
            document.getElementById('vn-face-upload-btn').addEventListener('click', () => document.getElementById('vn-face-upload').click());
            document.getElementById('vn-outfit-upload-btn').addEventListener('click', () => document.getElementById('vn-outfit-upload').click());
            document.getElementById('vn-accessory-upload-btn').addEventListener('click', () => document.getElementById('vn-accessory-upload').click());

            document.getElementById('vn-face-upload').addEventListener('change', (e) => previewImage(e, 'vn-face-preview'));
            document.getElementById('vn-outfit-upload').addEventListener('change', (e) => previewImage(e, 'vn-outfit-preview'));
            document.getElementById('vn-accessory-upload').addEventListener('change', (e) => previewImage(e, 'vn-accessory-preview'));

            // Modal close buttons
            document.getElementById('vn-alert-close-btn').addEventListener('click', () => closeModal('vn-alert-modal'));
            document.getElementById('vn-alert-ok-btn').addEventListener('click', () => closeModal('vn-alert-modal'));
            document.getElementById('vn-edit-close-btn').addEventListener('click', () => closeModal('vn-edit-modal'));
            document.getElementById('vn-image-viewer-modal').addEventListener('click', () => closeModal('vn-image-viewer-modal'));
            document.getElementById('vn-viewer-close-btn').addEventListener('click', (e) => { e.stopPropagation(); closeModal('vn-image-viewer-modal'); });
            enlargedImage.addEventListener('click', e => e.stopPropagation());

            let currentResultImageBase64 = null; 
            let selectedGalleryImageBase64 = null; 

            let vietnamLocations = [
                'Vịnh Hạ Long, Quảng Ninh', 'Đảo Tuần Châu, Quảng Ninh', 'Chùa Yên Tử, Quảng Ninh',
                'Ruộng bậc thang Sa Pa, Lào Cai', 'Đỉnh Fansipan, Lào Cai', 'Nhà thờ đá Sapa', 'Bản Cát Cát, Sa Pa',
                'Hồ Gươm (Hồ Hoàn Kiếm), Hà Nội', 'Cầu Thê Húc, Hà Nội', 'Nhà hát Lớn Hà Nội',
                'Lăng Chủ tịch Hồ Chí Minh, Hà Nội', 'Văn Miếu - Quốc Tử Giám, Hà Nội', 'Hoàng thành Thăng Long, Hà Nội',
                'Phố cổ Hà Nội', 'Cầu Long Biên, Hà Nội', 'Hồ Tây, Hà Nội',
                'Quần thể danh thắng Tràng An, Ninh Bình', 'Chùa Bái Đính, Ninh Bình', 'Tam Cốc - Bích Động, Ninh Bình', 'Hang Múa, Ninh Bình',
                'Cột cờ Lũng Cú, Hà Giang', 'Đèo Mã Pí Lèng, Hà Giang', 'Phố cổ Đồng Văn, Hà Giang',
                'Đảo Cát Bà, Hải Phòng', 'Chùa Hương, Hà Nội', 'Thung lũng Mộc Châu, Sơn La', 'Suối nước nóng Kim Bôi, Hòa Bình',
                'Phố cổ Hội An, Quảng Nam', 'Chùa Cầu, Hội An', 'Thánh địa Mỹ Sơn, Quảng Nam',
                'Cầu Vàng, Bà Nà Hills, Đà Nẵng', 'Biển Mỹ Khê, Đà Nẵng', 'Cầu Rồng, Đà Nẵng',
                'Cố đô Huế, Thừa Thiên Huế', 'Đại Nội Huế', 'Chùa Thiên Mụ, Huế', 'Lăng Khải Định, Huế', 'Lăng Minh Mạng, Huế',
                'Vườn quốc gia Phong Nha - Kẻ Bàng, Quảng Bình', 'Động Phong Nha', 'Động Thiên Đường', 'Hang Sơn Đoòng, Quảng Bình',
                'Eo Gió, Quy Nhơn, Bình Định', 'Kỳ Co, Quy Nhơn, Bình Định',
                'Tháp Bà Ponagar, Nha Trang', 'VinWonders Nha Trang', 'Hòn Chồng, Nha Trang',
                'Đồi cát trắng, Mũi Né, Phan Thiết', 'Đồi cát đỏ, Mũi Né, Phan Thiết', 'Làng chài Mũi Né, Phan Thiết',
                'Tháp đôi Chăm, Bình Định', 'Ghềnh Đá Đĩa, Phú Yên', 'Đầm Lập An, Huế',
                'Quảng trường Lâm Viên, Đà Lạt', 'Hồ Xuân Hương, Đà Lạt', 'Ga Đà Lạt', 'Thung lũng Tình Yêu, Đà Lạt',
                'Thiền Viện Trúc Lâm, Đà Lạt', 'Nhà thờ Con Gà, Đà Lạt', 'Đồi chè Cầu Đất, Đà Lạt',
                'Dinh Độc Lập, TP. Hồ Chí Minh', 'Chợ Bến Thành, TP. Hồ Chí Minh', 'Nhà thờ Đức Bà Sài Gòn',
                'Bưu điện Trung tâm Sài Gòn', 'Tòa nhà Landmark 81, TP. Hồ Chí Minh', 'Phố đi bộ Nguyễn Huệ, TP. Hồ Chí Minh',
                'Địa đạo Củ Chi',
                'Bãi Dài, Phú Quốc, Kiên Giang', 'Cáp treo Hòn Thơm, Phú Quốc', 'Dinh Cậu, Phú Quốc', 'Chợ đêm Phú Quốc',
                'Côn Đảo, Bà Rịa - Vũng Tàu', 'Tượng Chúa Kitô Vua, Vũng Tàu', 'Ngọn hải đăng Vũng Tàu',
                'Chợ nổi Cái Răng, Cần Thơ', 'Rừng tràm Trà Sư, An Giang', 'Chợ nổi Cái Bè, Tiền Giang', 'Đồng bằng sông Cửu Long'
            ];

            locationInput.addEventListener('input', () => {
                const query = locationInput.value.toLowerCase().trim();
                suggestionsContainer.innerHTML = '';
                if (query.length === 0) { suggestionsContainer.classList.add('hidden'); return; }
                const filteredLocations = vietnamLocations.filter(location => location.toLowerCase().includes(query));
                if (filteredLocations.length > 0) {
                    suggestionsContainer.classList.remove('hidden');
                    filteredLocations.slice(0, 10).forEach(location => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.classList.add('suggestion-item');
                        suggestionItem.textContent = location;
                        suggestionItem.addEventListener('click', () => {
                            locationInput.value = location;
                            suggestionsContainer.innerHTML = '';
                            suggestionsContainer.classList.add('hidden');
                        });
                        suggestionsContainer.appendChild(suggestionItem);
                    });
                } else {
                    suggestionsContainer.classList.add('hidden');
                }
            });

            saveLocationBtn.addEventListener('click', () => {
                const newLocation = locationInput.value.trim();
                if (newLocation === '') { showAlert('Vui lòng nhập một địa điểm để lưu.'); return; }
                const isDuplicate = vietnamLocations.some(loc => loc.toLowerCase() === newLocation.toLowerCase());
                if (isDuplicate) { showAlert('Địa điểm này đã có trong danh sách.'); } 
                else {
                    vietnamLocations.unshift(newLocation);
                    locationInput.value = '';
                    showAlert(`Đã lưu địa điểm mới: "${newLocation}"`);
                }
            });

            document.addEventListener('click', (event) => {
                if (!locationInput.contains(event.target) && !suggestionsContainer.contains(event.target)) {
                    suggestionsContainer.classList.add('hidden');
                }
            });

            generateSingleBtn.addEventListener('click', () => generateImage(1));
            generateMultipleBtn.addEventListener('click', () => generateImage(5));
            downloadBtn.addEventListener('click', downloadImage);
            editBtn.addEventListener('click', () => openEditModal(currentResultImageBase64));
            confirmEditBtn.addEventListener('click', applyEdit);
            downloadSelectedBtn.addEventListener('click', downloadSelectedImage);
            editSelectedBtn.addEventListener('click', () => {
                if (selectedGalleryImageBase64) { openEditModal(selectedGalleryImageBase64); } 
                else { showAlert('Vui lòng chọn một ảnh trong thư viện để chỉnh sửa.'); }
            });

            function previewImage(event, previewId) {
                const reader = new FileReader();
                reader.onload = function() {
                    const output = document.getElementById(previewId);
                    output.style.backgroundImage = `url('${reader.result}')`;
                    output.textContent = '';
                };
                if (event.target.files[0]) { reader.readAsDataURL(event.target.files[0]); }
            }

            function showAlert(message, modalId = 'vn-alert-modal') {
                const modal = document.getElementById(modalId);
                modal.querySelector('#vn-alert-message').textContent = message;
                modal.classList.remove('hidden');
            }

            function closeModal(modalId) {
                document.getElementById(modalId).classList.add('hidden');
                if (modalId === 'vn-edit-modal') { editPromptInput.value = ''; }
            }

            function openImageViewer(base64) {
                if (base64) {
                    enlargedImage.src = `data:image/png;base64,${base64}`;
                    imageViewerModal.classList.remove('hidden');
                }
            }

            function showLoader(message = 'AI đang sáng tạo, vui lòng chờ trong giây lát...') {
                resultSection.style.display = 'block';
                loaderContainer.style.display = 'flex';
                loaderContainer.querySelector('p').textContent = message;
                singleImageResult.classList.add('hidden');
                galleryResults.classList.add('hidden');
                galleryActions.classList.add('hidden');
                errorMessage.textContent = '';
            }

            function hideLoader() { loaderContainer.style.display = 'none'; }

            function displaySingleImage(base64Image) {
                currentResultImageBase64 = base64Image;
                resultImage.src = `data:image/png;base64,${base64Image}`;
                singleImageContainer.onclick = () => openImageViewer(base64Image);
                singleImageResult.classList.remove('hidden');
                galleryResults.classList.add('hidden');
                galleryActions.classList.add('hidden');
            }

            function displayGalleryImages(base64Images) {
                galleryResults.innerHTML = '';
                // selectedGalleryImageBase64 = null; // No longer needed
                base64Images.forEach((base64, index) => {
                    const itemWrapper = document.createElement('div');
                    itemWrapper.className = 'flex flex-col gap-2';

                    const imgDiv = document.createElement('div');
                    imgDiv.classList.add('gallery-item', 'shadow-md', 'relative');
                    imgDiv.innerHTML = `<img src="data:image/png;base64,${base64}" alt="Ảnh AI ${index + 1}">`;
                    imgDiv.addEventListener('click', () => {
                        openImageViewer(base64);
                    });

                    const buttonsContainer = document.createElement('div');
                    buttonsContainer.className = 'flex justify-center gap-2';

                    // Download button
                    const downloadLink = document.createElement('a');
                    downloadLink.href = `data:image/png;base64,${base64}`;
                    downloadLink.download = `AI_Photoshoot_Vietnam_${Date.now()}_${index}.png`;
                    downloadLink.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg transition duration-300 text-sm text-center';
                    downloadLink.textContent = 'Tải';

                    // Edit button
                    const editButton = document.createElement('button');
                    editButton.className = 'w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-3 rounded-lg transition duration-300 text-sm';
                    editButton.textContent = 'Sửa';
                    editButton.onclick = () => {
                        openEditModal(base64);
                    };

                    buttonsContainer.appendChild(downloadLink);
                    buttonsContainer.appendChild(editButton);

                    itemWrapper.appendChild(imgDiv);
                    itemWrapper.appendChild(buttonsContainer);
                    galleryResults.appendChild(itemWrapper);
                });
                singleImageResult.classList.add('hidden');
                galleryResults.classList.remove('hidden');
                galleryActions.classList.add('hidden'); // Hide main actions as they are now per-image
            }

            function downloadImage() {
                if (currentResultImageBase64) {
                    const link = document.createElement('a');
                    link.href = `data:image/png;base64,${currentResultImageBase64}`;
                    link.download = `AI_Photoshoot_${Date.now()}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    showAlert('Không có ảnh để tải về.');
                }
            }

            function downloadSelectedImage() {
                if (selectedGalleryImageBase64) {
                    const link = document.createElement('a');
                    link.href = `data:image/png;base64,${selectedGalleryImageBase64}`;
                    link.download = `AI_Photoshoot_${Date.now()}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    showAlert('Vui lòng chọn một ảnh trong thư viện để tải về.');
                }
            }

            function openEditModal(base64Image) {
                if (!base64Image) { showAlert('Không có ảnh để chỉnh sửa. Vui lòng tạo ảnh trước.'); return; }
                editModal.classList.remove('hidden');
                currentResultImageBase64 = base64Image;
            }

            function vnTool_fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = error => reject(error);
                });
            }

            async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (response.status === 429 || response.status >= 500) { throw new Error(`Server error: ${response.status}`); }
                        return response;
                    } catch (error) {
                        console.warn(`Attempt ${i + 1} failed. Retrying in ${delay / 1000}s...`);
                        if (i < retries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2;
                        } else { throw error; }
                    }
                }
            }

            async function callImageAPI(payload) {
                try {
                    const apiKey = "AIzaSyAAgKXiYFW4-ANBJ08W39gj_vHvhBSD6kQ";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                    const response = await fetchWithBackoff(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorBody = await response.json();
                        console.error(`API Error details:`, errorBody);
                        return null;
                    }
                    const result = await response.json();
                    const imagePart = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                    if (imagePart && imagePart.inlineData.data) { return imagePart.inlineData.data; } 
                    else { console.error('No valid image part found in API response:', result); return null; }
                } catch (error) {
                    console.error('Error in callImageAPI:', error);
                    return null;
                }
            }

            async function generateImage(numImages = 1) {
                const faceFile = document.getElementById('vn-face-upload').files[0];
                const outfitFile = document.getElementById('vn-outfit-upload').files[0];
                const accessoryFile = document.getElementById('vn-accessory-upload').files[0];
                const location = document.getElementById('vn-location-input').value;
                const customPrompt = document.getElementById('vn-prompt-input').value;

                if (!faceFile || !outfitFile) { showAlert('Vui lòng tải lên cả ảnh chân dung và ảnh trang phục.'); return; }
                if (!location.trim()) { showAlert('Vui lòng nhập một địa điểm.'); return; }

                generateSingleBtn.disabled = true;
                generateMultipleBtn.disabled = true;
                generateSingleBtn.classList.add('opacity-50', 'cursor-not-allowed');
                generateMultipleBtn.classList.add('opacity-50', 'cursor-not-allowed');
                generateSingleBtn.textContent = 'Đang xử lý...';
                generateMultipleBtn.textContent = 'Đang xử lý...';

                showLoader(numImages === 1 ? 'AI đang sáng tạo ảnh...' : `AI đang tạo ${numImages} ảnh...`);

                try {
                    const faceBase64 = await vnTool_fileToBase64(faceFile);
                    const outfitBase64 = await vnTool_fileToBase64(outfitFile);
                    let accessoryBase64 = null;
                    if (accessoryFile) { accessoryBase64 = await vnTool_fileToBase64(accessoryFile); }

                    const accessoryPrompt = accessoryBase64 ? `Incorporate the accessory from the third image onto the person.` : '';
                    let imageResults = [];
                    const basePrompt = `Take the face from the first image and the outfit from the second image. ${accessoryPrompt} Create a new, photorealistic image placing this person at ${location}, Vietnam. The composition should be seamless, with realistic lighting and shadows that match the background. ${customPrompt}. Keep the face identical to the source image. FINAL AND MOST IMPORTANT INSTRUCTION: The final image's aspect ratio ABSOLUTELY MUST BE a vertical 9:16 portrait. Do not generate a 1:1 square image under any circumstances. The output must be tall and vertical (9:16).`;
                    
                    if (numImages > 1) {
                        const apiPromises = [];
                        for (let i = 0; i < numImages; i++) {
                            const finalPrompt = `${basePrompt} Pose variation #${i + 1}.`;
                            const parts = [
                                { text: finalPrompt },
                                { inlineData: { mimeType: faceFile.type, data: faceBase64 } },
                                { inlineData: { mimeType: outfitFile.type, data: outfitBase64 } }
                            ];
                            if (accessoryBase64) { parts.push({ inlineData: { mimeType: accessoryFile.type, data: accessoryBase64 } }); }
                            const payload = { contents: [{ parts: parts }], generationConfig: { responseModalities: ['IMAGE'] } };
                            apiPromises.push(callImageAPI(payload));
                        }
                        const results = await Promise.all(apiPromises);
                        imageResults = results.filter(img => img !== null);
                    } else {
                        const parts = [
                            { text: basePrompt },
                            { inlineData: { mimeType: faceFile.type, data: faceBase64 } },
                            { inlineData: { mimeType: outfitFile.type, data: outfitBase64 } }
                        ];
                        if (accessoryBase64) { parts.push({ inlineData: { mimeType: accessoryFile.type, data: accessoryBase64 } }); }
                        const payload = { contents: [{ parts: parts }], generationConfig: { responseModalities: ['IMAGE'] } };
                        const singleResult = await callImageAPI(payload);
                        if (singleResult) { imageResults.push(singleResult); }
                    }

                    hideLoader();
                    if (imageResults.length > 0) {
                        if (imageResults.length === 1 && numImages === 1) { displaySingleImage(imageResults[0]); } 
                        else { displayGalleryImages(imageResults); }
                    } else {
                        throw new Error('Không nhận được hình ảnh hợp lệ từ AI. Vui lòng thử lại.');
                    }
                } catch (error) {
                    console.error('Error generating image:', error);
                    hideLoader();
                    errorMessage.textContent = `Đã xảy ra lỗi: ${error.message}. Vui lòng thử lại sau.`;
                    singleImageResult.classList.remove('hidden');
                    resultImage.src = 'https://placehold.co/1080x1920/1f2937/9ca3af?text=Lỗi+tạo+ảnh';
                } finally {
                    generateSingleBtn.disabled = false;
                    generateMultipleBtn.disabled = false;
                    generateSingleBtn.textContent = 'Tạo 1 ảnh AI';
                    generateMultipleBtn.textContent = 'Tạo 5 ảnh với pose khác nhau';
                    generateSingleBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    generateMultipleBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }

            async function applyEdit() {
                const editPrompt = editPromptInput.value.trim();
                const imageToEditBase64 = currentResultImageBase64;
                if (!editPrompt) { showAlert('Vui lòng nhập mô tả chỉnh sửa.'); return; }
                if (!imageToEditBase64) { showAlert('Không có ảnh để chỉnh sửa. Vui lòng tạo ảnh trước.'); return; }

                closeModal('vn-edit-modal');
                showLoader('AI đang chỉnh sửa ảnh của bạn...');

                try {
                    const payload = {
                        contents: [{
                            parts: [
                                { text: `Modify the provided image: ${editPrompt}. FINAL AND MOST IMPORTANT INSTRUCTION: The final edited image's aspect ratio ABSOLUTELY MUST BE a vertical 9:16 portrait, maintaining the original's tall format. Do not output a 1:1 square or landscape image under any circumstances.` },
                                { inlineData: { mimeType: 'image/png', data: imageToEditBase64 } }
                            ]
                        }],
                        generationConfig: { responseModalities: ['IMAGE'] },
                    };
                    const editedImageBase64 = await callImageAPI(payload);
                    hideLoader();
                    if (editedImageBase64) { displaySingleImage(editedImageBase64); } 
                    else { throw new Error('Không nhận được hình ảnh hợp lệ từ AI sau chỉnh sửa.'); }
                } catch (error) {
                    console.error('Error applying edit:', error);
                    hideLoader();
                    errorMessage.textContent = `Đã xảy ra lỗi khi chỉnh sửa: ${error.message}. Vui lòng thử lại.`;
                    singleImageResult.classList.remove('hidden');
                    resultImage.src = 'https://placehold.co/1080x1920/1f2937/9ca3af?text=Lỗi+chỉnh+sửa+ảnh';
                }
            }
            isVnToolInitialized = true;
        }
    </script>
</body>
</html>